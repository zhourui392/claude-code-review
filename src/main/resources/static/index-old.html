<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gitä»£ç ReviewæœåŠ¡</title>
    <link href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
        }
        .review-result {
            background: #ffffff;
            padding: 20px;
            border-radius: 4px;
            margin-top: 20px;
            border: 1px solid #e6e6e6;
        }
        /* Markdown æ¸²æŸ“æ ·å¼ */
        .review-result h1 {
            font-size: 28px;
            border-bottom: 2px solid #409eff;
            padding-bottom: 10px;
            margin-top: 20px;
            margin-bottom: 15px;
        }
        .review-result h2 {
            font-size: 24px;
            border-bottom: 1px solid #dcdfe6;
            padding-bottom: 8px;
            margin-top: 18px;
            margin-bottom: 12px;
        }
        .review-result h3 {
            font-size: 20px;
            margin-top: 16px;
            margin-bottom: 10px;
            color: #303133;
        }
        .review-result h4 {
            font-size: 18px;
            margin-top: 14px;
            margin-bottom: 8px;
            color: #606266;
        }
        .review-result p {
            margin: 10px 0;
            line-height: 1.6;
            color: #606266;
        }
        .review-result ul, .review-result ol {
            margin: 10px 0;
            padding-left: 30px;
        }
        .review-result li {
            margin: 5px 0;
            line-height: 1.5;
        }
        .review-result code {
            background: #f5f7fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', Consolas, Monaco, monospace;
            font-size: 13px;
            color: #e83e8c;
        }
        .review-result pre {
            background: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 15px 0;
        }
        .review-result pre code {
            background: none;
            color: #abb2bf;
            padding: 0;
        }
        .review-result blockquote {
            border-left: 4px solid #409eff;
            padding-left: 15px;
            margin: 15px 0;
            color: #909399;
            background: #f5f7fa;
            padding: 10px 15px;
            border-radius: 0 4px 4px 0;
        }
        .review-result table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }
        .review-result table th {
            background: #f5f7fa;
            padding: 10px;
            border: 1px solid #dcdfe6;
            font-weight: bold;
        }
        .review-result table td {
            padding: 10px;
            border: 1px solid #dcdfe6;
        }
        .review-result a {
            color: #409eff;
            text-decoration: none;
        }
        .review-result a:hover {
            text-decoration: underline;
        }
        .review-result hr {
            border: none;
            border-top: 1px solid #dcdfe6;
            margin: 20px 0;
        }
        .review-result strong {
            font-weight: 600;
            color: #303133;
        }
        .review-result em {
            font-style: italic;
            color: #606266;
        }
        .test-progress {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e6e6e6;
        }
        .test-result {
            margin-top: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e6e6e6;
        }
        .code-container {
            border: 1px solid #e6e6e6;
            border-radius: 4px;
            overflow: hidden;
        }
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f8f8;
            border-bottom: 1px solid #e6e6e6;
            font-weight: bold;
        }
        .code-content {
            background: #ffffff;
            padding: 15px;
            margin: 0;
            max-height: 600px;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
        }
        .test-output {
            margin-top: 15px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 4px;
            border: 1px solid #e6e6e6;
        }
        .test-output pre {
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.3;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>Gitä»£ç ReviewæœåŠ¡</h1>
                <p>ä½¿ç”¨Claude AIè¿›è¡Œè‡ªåŠ¨åŒ–ä»£ç å®¡æŸ¥</p>
            </div>

            <el-tabs type="border-card" v-model="activeTab">
                <el-tab-pane label="ä»“åº“ç®¡ç†" name="repos">
                    <div class="section">
                        <h3>Gitä»“åº“é…ç½®</h3>
                        <el-button type="primary" @click="showAddDialog = true">æ·»åŠ ä»“åº“</el-button>
                        
                        <el-table :data="repositories" style="width: 100%; margin-top: 20px;">
                            <el-table-column prop="name" label="ä»“åº“åç§°"></el-table-column>
                            <el-table-column prop="repositoryUrl" label="ä»“åº“åœ°å€"></el-table-column>
                            <el-table-column prop="description" label="æè¿°"></el-table-column>
                            <el-table-column label="æ“ä½œ" width="200">
                                <template slot-scope="scope">
                                    <el-button size="mini" @click="testConnection(scope.row)">æµ‹è¯•è¿æ¥</el-button>
                                    <el-button size="mini" type="danger" @click="deleteRepository(scope.row.id)">åˆ é™¤</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>
                </el-tab-pane>

                <el-tab-pane label="ä»£ç Review">
                    <div class="section">
                        <h3>ä»£ç å®¡æŸ¥</h3>
                        
                        <el-form :model="reviewForm" label-width="120px">
                            <el-form-item label="é€‰æ‹©ä»“åº“">
                                <el-select v-model="reviewForm.repositoryId" placeholder="è¯·é€‰æ‹©ä»“åº“" @change="loadBranches">
                                    <el-option v-for="repo in repositories" 
                                               :key="repo.id" 
                                               :label="repo.name" 
                                               :value="repo.id">
                                    </el-option>
                                </el-select>
                                <el-button style="margin-left: 10px" @click="loadRemoteBranches" :loading="remoteLoading">
                                    ä»è¿œç¨‹æ‹‰å–åˆ†æ”¯
                                </el-button>
                            </el-form-item>

                            <el-form-item label="åŸºç¡€åˆ†æ”¯">
                                <el-select v-model="reviewForm.baseBranch" placeholder="è¯·é€‰æ‹©åŸºç¡€åˆ†æ”¯" filterable allow-create>
                                    <el-option v-for="branch in branches" 
                                               :key="'base-' + branch" 
                                               :label="branch" 
                                               :value="branch">
                                    </el-option>
                                </el-select>
                            </el-form-item>
                            
                            <el-form-item label="ç›®æ ‡åˆ†æ”¯">
                                <el-select v-model="reviewForm.targetBranch" placeholder="è¯·é€‰æ‹©ç›®æ ‡åˆ†æ”¯" filterable allow-create>
                                    <el-option v-for="branch in branches"
                                               :key="'target-' + branch"
                                               :label="branch"
                                               :value="branch">
                                    </el-option>
                                </el-select>
                            </el-form-item>

                            <el-form-item label="å®¡æŸ¥æ¨¡å¼">
                                <el-select v-model="reviewForm.mode" placeholder="è¯·é€‰æ‹©å®¡æŸ¥æ¨¡å¼">
                                    <el-option label="âš¡ å¿«é€Ÿå®¡æŸ¥ (2-5åˆ†é’Ÿ)" value="quick">
                                        <span style="float: left">âš¡ å¿«é€Ÿå®¡æŸ¥</span>
                                        <span style="float: right; color: #8492a6; font-size: 13px">2-5åˆ†é’Ÿ</span>
                                    </el-option>
                                    <el-option label="ğŸ“‹ æ ‡å‡†å®¡æŸ¥ (5-10åˆ†é’Ÿ)" value="standard">
                                        <span style="float: left">ğŸ“‹ æ ‡å‡†å®¡æŸ¥</span>
                                        <span style="float: right; color: #8492a6; font-size: 13px">5-10åˆ†é’Ÿ</span>
                                    </el-option>
                                    <el-option label="ğŸ” æ·±åº¦å®¡æŸ¥ (10-20åˆ†é’Ÿ)" value="deep">
                                        <span style="float: left">ğŸ” æ·±åº¦å®¡æŸ¥</span>
                                        <span style="float: right; color: #8492a6; font-size: 13px">10-20åˆ†é’Ÿ</span>
                                    </el-option>
                                    <el-option label="ğŸ”’ å®‰å…¨å®¡æŸ¥ (5-10åˆ†é’Ÿ)" value="security">
                                        <span style="float: left">ğŸ”’ å®‰å…¨å®¡æŸ¥</span>
                                        <span style="float: right; color: #8492a6; font-size: 13px">5-10åˆ†é’Ÿ</span>
                                    </el-option>
                                    <el-option label="âš¡ æ€§èƒ½å®¡æŸ¥ (5-10åˆ†é’Ÿ)" value="performance">
                                        <span style="float: left">âš¡ æ€§èƒ½å®¡æŸ¥</span>
                                        <span style="float: right; color: #8492a6; font-size: 13px">5-10åˆ†é’Ÿ</span>
                                    </el-option>
                                    <el-option label="ğŸ—ï¸ æ¶æ„å®¡æŸ¥ (5-10åˆ†é’Ÿ)" value="architecture">
                                        <span style="float: left">ğŸ—ï¸ æ¶æ„å®¡æŸ¥</span>
                                        <span style="float: right; color: #8492a6; font-size: 13px">5-10åˆ†é’Ÿ</span>
                                    </el-option>
                                </el-select>
                                <el-alert
                                    v-if="reviewForm.mode"
                                    :title="getModeDescription(reviewForm.mode)"
                                    type="info"
                                    :closable="false"
                                    style="margin-top: 10px">
                                </el-alert>
                            </el-form-item>

                            <el-form-item>
                                <el-button type="primary" @click="startReview" :loading="reviewLoading">
                                    å¼€å§‹Review
                                </el-button>
                            </el-form-item>
                        </el-form>

                        <div v-if="reviewResult" class="review-result">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0;">Reviewç»“æœï¼š</h4>
                                <el-button-group v-if="currentReviewId">
                                    <el-button
                                        size="small"
                                        icon="el-icon-download"
                                        @click="exportMarkdown"
                                        :loading="exportLoading">
                                        å¯¼å‡º Markdown
                                    </el-button>
                                    <el-button
                                        size="small"
                                        icon="el-icon-document"
                                        @click="exportJson"
                                        :loading="exportLoading">
                                        å¯¼å‡º JSON
                                    </el-button>
                                </el-button-group>
                            </div>
                            <div v-html="renderedReviewResult"></div>
                        </div>
                    </div>
                </el-tab-pane>

                <el-tab-pane label="å•å…ƒæµ‹è¯•ç”Ÿæˆ">
                    <div class="section">
                        <h3>æ™ºèƒ½å•å…ƒæµ‹è¯•ç”Ÿæˆ</h3>

                        <el-form :model="testGenForm" label-width="120px">
                            <el-form-item label="é€‰æ‹©ä»“åº“">
                                <el-select v-model="testGenForm.repositoryId" placeholder="è¯·é€‰æ‹©ä»“åº“" @change="loadTestBranches">
                                    <el-option v-for="repo in repositories"
                                               :key="repo.id"
                                               :label="repo.name"
                                               :value="repo.id">
                                    </el-option>
                                </el-select>
                            </el-form-item>

                            <el-form-item label="åˆ†æ”¯">
                                <el-select v-model="testGenForm.branch" placeholder="è¯·é€‰æ‹©åˆ†æ”¯" filterable allow-create>
                                    <el-option v-for="branch in testBranches"
                                               :key="'test-' + branch"
                                               :label="branch"
                                               :value="branch">
                                    </el-option>
                                </el-select>
                            </el-form-item>

                            <el-form-item label="Javaç±»å">
                                <el-input
                                    type="textarea"
                                    v-model="testGenForm.className"
                                    :rows="3"
                                    placeholder="ä¾‹å¦‚: UserService æˆ– UserService,OrderService,ProductService (é€—å·åˆ†éš”å¤šä¸ªç±»)">
                                </el-input>
                                <div style="color: #909399; font-size: 12px; margin-top: 5px;">
                                    æ”¯æŒè¾“å…¥å¤šä¸ªç±»åï¼Œä½¿ç”¨è‹±æ–‡é€—å·åˆ†éš”
                                </div>
                            </el-form-item>

                            <el-form-item label="å‡†å…¥ID">
                                <el-input v-model="testGenForm.gateId" placeholder="å¯é€‰ï¼Œæœªå¡«å†™åˆ™ä»Gitå†å²æå–">
                                    <template slot="prepend">Gate ID</template>
                                </el-input>
                                <div style="color: #909399; font-size: 12px; margin-top: 5px;">
                                    å¦‚ä¸å¡«å†™ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä»æœ€è¿‘çš„Gitæäº¤å†å²ä¸­æå–å‡†å…¥ID
                                </div>
                            </el-form-item>

                            <el-form-item label="æµ‹è¯•è¦æ±‚">
                                <el-input
                                    type="textarea"
                                    v-model="testGenForm.requirement"
                                    :rows="4"
                                    placeholder="å¯é€‰ï¼Œè¾“å…¥å¯¹æµ‹è¯•ä»£ç çš„ç‰¹æ®Šè¦æ±‚ï¼ˆå¦‚ï¼šéœ€è¦æµ‹è¯•è¾¹ç•Œæ¡ä»¶ã€éœ€è¦è¦†ç›–å¼‚å¸¸åœºæ™¯ç­‰ï¼‰">
                                </el-input>
                                <div style="color: #909399; font-size: 12px; margin-top: 5px;">
                                    å¯é€‰å¡«å†™ï¼Œç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤çš„Mockæµ‹è¯•æ ‡å‡†ï¼ˆå®Œç¾è´¨é‡ï¼‰
                                </div>
                            </el-form-item>

                            <el-form-item>
                                <el-button type="primary" @click="startTestGeneration" :loading="testGenLoading">
                                    ç”Ÿæˆæµ‹è¯•ä»£ç 
                                </el-button>
                                <el-button @click="resetTestForm">é‡ç½®</el-button>
                            </el-form-item>
                        </el-form>

                        <!-- è¿›åº¦æ˜¾ç¤º -->
                        <div v-if="testGenProgress.show" class="test-progress">
                            <h4>ç”Ÿæˆè¿›åº¦</h4>
                            <el-steps :active="testGenProgress.currentStep" finish-status="success">
                                <el-step title="åˆ†ææºç " description="è§£æJavaç±»ç»“æ„"></el-step>
                                <el-step title="ç”Ÿæˆæµ‹è¯•" description="Claude AIç”Ÿæˆæµ‹è¯•ä»£ç "></el-step>
                                <el-step title="éªŒè¯ç¼–è¯‘" description="æ£€æŸ¥æµ‹è¯•ä»£ç è¯­æ³•"></el-step>
                                <el-step title="æ‰§è¡Œæµ‹è¯•" description="è¿è¡Œå¹¶éªŒè¯æµ‹è¯•"></el-step>
                            </el-steps>
                            <el-progress :percentage="testGenProgress.percentage"
                                        :status="testGenProgress.status"
                                        style="margin-top: 20px;">
                            </el-progress>
                            <div v-if="testGenProgress.message" style="margin-top: 10px; color: #666;">
                                {{ testGenProgress.message }}
                            </div>
                        </div>

                        <!-- ç»“æœå±•ç¤º -->
                        <div v-if="testGenResult.show" class="test-result">
                            <h4>ç”Ÿæˆç»“æœ</h4>
                            <el-tabs type="card">
                                <el-tab-pane label="æµ‹è¯•ä»£ç ">
                                    <div class="code-container">
                                        <div class="code-header">
                                            <span>{{ testGenResult.testFileName }}</span>
                                            <div>
                                                <el-button size="mini" @click="copyTestCode">å¤åˆ¶ä»£ç </el-button>
                                                <el-button size="mini" type="primary" @click="downloadTestCode">ä¸‹è½½æ–‡ä»¶</el-button>
                                            </div>
                                        </div>
                                        <pre class="code-content"><code>{{ testGenResult.testCode }}</code></pre>
                                    </div>
                                </el-tab-pane>
                                <el-tab-pane label="æ‰§è¡Œç»“æœ">
                                    <el-descriptions border>
                                        <el-descriptions-item label="ç¼–è¯‘çŠ¶æ€">
                                            <el-tag :type="testGenResult.compilationSuccess ? 'success' : 'danger'">
                                                {{ testGenResult.compilationSuccess ? 'ç¼–è¯‘æˆåŠŸ' : 'ç¼–è¯‘å¤±è´¥' }}
                                            </el-tag>
                                        </el-descriptions-item>
                                        <el-descriptions-item label="æµ‹è¯•é€šè¿‡">
                                            <el-tag :type="testGenResult.testsPass ? 'success' : 'warning'">
                                                {{ testGenResult.testsPass ? 'å…¨éƒ¨é€šè¿‡' : 'éƒ¨åˆ†å¤±è´¥' }}
                                            </el-tag>
                                        </el-descriptions-item>
                                        <el-descriptions-item label="è¦†ç›–ç‡">
                                            <span>{{ testGenResult.coveragePercentage }}%</span>
                                        </el-descriptions-item>
                                        <el-descriptions-item label="ç”Ÿæˆæ—¶é—´">
                                            <span>{{ testGenResult.generationTime }}ç§’</span>
                                        </el-descriptions-item>
                                    </el-descriptions>
                                    <div v-if="testGenResult.output" class="test-output">
                                        <h5>æ‰§è¡Œè¾“å‡ºï¼š</h5>
                                        <pre>{{ testGenResult.output }}</pre>
                                    </div>
                                </el-tab-pane>
                            </el-tabs>
                        </div>
                    </div>
                </el-tab-pane>

                <el-tab-pane label="AIè¾…åŠ©å¼€å‘" name="workflow">
                    <div class="section">
                        <h3>AIè¾…åŠ©å¼€å‘å·¥ä½œæµ</h3>
                        <el-button type="primary" @click="showCreateWorkflowDialog = true" icon="el-icon-plus">
                            åˆ›å»ºå·¥ä½œæµ
                        </el-button>

                        <el-table :data="workflows" style="width: 100%; margin-top: 20px;" v-loading="workflowsLoading">
                            <el-table-column prop="name" label="å·¥ä½œæµåç§°" width="200"></el-table-column>
                            <el-table-column label="çŠ¶æ€" width="150">
                                <template slot-scope="scope">
                                    <el-tag :type="getStatusType(scope.row.status)" size="small">
                                        {{ getStatusText(scope.row.status) }}
                                    </el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="è¿›åº¦" width="200">
                                <template slot-scope="scope">
                                    <el-progress :percentage="scope.row.progress" :color="getProgressColor(scope.row.progress)"></el-progress>
                                </template>
                            </el-table-column>
                            <el-table-column prop="currentStage" label="å½“å‰é˜¶æ®µ"></el-table-column>
                            <el-table-column label="åˆ›å»ºæ—¶é—´" width="180">
                                <template slot-scope="scope">
                                    {{ formatDate(scope.row.createdAt) }}
                                </template>
                            </el-table-column>
                            <el-table-column label="æ“ä½œ" width="280">
                                <template slot-scope="scope">
                                    <el-button-group>
                                        <el-button size="mini" @click="viewWorkflowDetail(scope.row)" icon="el-icon-view">
                                            æŸ¥çœ‹
                                        </el-button>
                                        <el-button size="mini" type="primary" @click="continueWorkflow(scope.row)"
                                                   :disabled="!canContinue(scope.row)" icon="el-icon-right">
                                            ç»§ç»­
                                        </el-button>
                                        <el-button size="mini" type="danger" @click="cancelWorkflow(scope.row)"
                                                   :disabled="!canCancel(scope.row)" icon="el-icon-close">
                                            å–æ¶ˆ
                                        </el-button>
                                    </el-button-group>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>
                </el-tab-pane>
            </el-tabs>

            <!-- æ·»åŠ ä»“åº“å¯¹è¯æ¡† -->
            <el-dialog title="æ·»åŠ Gitä»“åº“" :visible.sync="showAddDialog" width="500px">
                <el-form :model="newRepository" label-width="100px">
                    <el-form-item label="ä»“åº“åç§°">
                        <el-input v-model="newRepository.name"></el-input>
                    </el-form-item>
                    <el-form-item label="ä»“åº“åœ°å€">
                        <el-input v-model="newRepository.url"></el-input>
                    </el-form-item>
                    <el-form-item label="ç”¨æˆ·å">
                        <el-input v-model="newRepository.username"></el-input>
                    </el-form-item>
                    <el-form-item label="å¯†ç ">
                        <el-input v-model="newRepository.password" type="password"></el-input>
                    </el-form-item>
                    <el-form-item label="æè¿°">
                        <el-input v-model="newRepository.description" type="textarea"></el-input>
                    </el-form-item>
                </el-form>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="showAddDialog = false">å–æ¶ˆ</el-button>
                    <el-button type="primary" @click="addRepository">ç¡®å®š</el-button>
                </span>
            </el-dialog>

            <!-- åˆ›å»ºå·¥ä½œæµå¯¹è¯æ¡† -->
            <el-dialog title="åˆ›å»ºAIè¾…åŠ©å¼€å‘å·¥ä½œæµ" :visible.sync="showCreateWorkflowDialog" width="700px">
                <el-form :model="newWorkflow" label-width="130px">
                    <el-form-item label="å·¥ä½œæµåç§°">
                        <el-input v-model="newWorkflow.name" placeholder="ä¾‹å¦‚ï¼šç”¨æˆ·ç™»å½•åŠŸèƒ½å¼€å‘"></el-input>
                    </el-form-item>
                    <el-form-item label="é€‰æ‹©ä»“åº“">
                        <el-select v-model="newWorkflow.repositoryId" placeholder="è¯·é€‰æ‹©ä»“åº“" style="width: 100%">
                            <el-option v-for="repo in repositories"
                                       :key="repo.id"
                                       :label="repo.name"
                                       :value="repo.id">
                            </el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="PRDå†…å®¹">
                        <el-input type="textarea" v-model="newWorkflow.prdContent" :rows="6"
                                  placeholder="è¯·è¾“å…¥äº§å“éœ€æ±‚æ–‡æ¡£å†…å®¹..."></el-input>
                    </el-form-item>

                    <el-divider>ä»£ç é£æ ¼é…ç½®ï¼ˆå¯é€‰ï¼‰</el-divider>

                    <el-form-item label="æ¶æ„æ¨¡å¼">
                        <el-select v-model="newWorkflow.architecture" placeholder="é»˜è®¤ï¼šDDD å…­è¾¹å½¢æ¶æ„" clearable style="width: 100%">
                            <el-option label="DDD å…­è¾¹å½¢æ¶æ„ï¼ˆDomain/Application/Infrastructureï¼‰" value="DDD å…­è¾¹å½¢æ¶æ„ï¼ˆDomain/Application/Infrastructureï¼‰"></el-option>
                            <el-option label="MVC ä¸‰å±‚æ¶æ„ï¼ˆController/Service/DAOï¼‰" value="MVC ä¸‰å±‚æ¶æ„ï¼ˆController/Service/DAOï¼‰"></el-option>
                            <el-option label="åˆ†å±‚æ¶æ„ï¼ˆPresentation/Business/Persistenceï¼‰" value="åˆ†å±‚æ¶æ„ï¼ˆPresentation/Business/Persistenceï¼‰"></el-option>
                            <el-option label="å¾®æœåŠ¡æ¶æ„ï¼ˆAPI Gateway + Service Meshï¼‰" value="å¾®æœåŠ¡æ¶æ„ï¼ˆAPI Gateway + Service Meshï¼‰"></el-option>
                            <el-option label="Clean Architectureï¼ˆæ•´æ´æ¶æ„ï¼‰" value="Clean Architectureï¼ˆæ•´æ´æ¶æ„ï¼‰"></el-option>
                        </el-select>
                    </el-form-item>

                    <el-form-item label="ç¼–ç è§„èŒƒ">
                        <el-select v-model="newWorkflow.codingStyle" placeholder="é»˜è®¤ï¼šAlibaba-P3C" clearable style="width: 100%">
                            <el-option label="Alibaba-P3C è§„èŒƒ" value="Alibaba-P3C è§„èŒƒ"></el-option>
                            <el-option label="Google Java Style Guide" value="Google Java Style Guide"></el-option>
                            <el-option label="Spring Boot æœ€ä½³å®è·µ" value="Spring Boot æœ€ä½³å®è·µ"></el-option>
                            <el-option label="é˜¿é‡Œå·´å·´å¾®æœåŠ¡è§„èŒƒ" value="é˜¿é‡Œå·´å·´å¾®æœåŠ¡è§„èŒƒ"></el-option>
                        </el-select>
                    </el-form-item>

                    <el-form-item label="å‘½åè§„èŒƒ">
                        <el-select v-model="newWorkflow.namingConvention" placeholder="é»˜è®¤ï¼šé©¼å³°å‘½åæ³•" clearable style="width: 100%">
                            <el-option label="é©¼å³°å‘½åæ³•ï¼ˆcamelCaseï¼‰" value="é©¼å³°å‘½åæ³•"></el-option>
                            <el-option label="ä¸‹åˆ’çº¿å‘½åæ³•ï¼ˆsnake_caseï¼‰" value="ä¸‹åˆ’çº¿å‘½åæ³•"></el-option>
                        </el-select>
                    </el-form-item>

                    <el-form-item label="æ³¨é‡Šè¯­è¨€">
                        <el-select v-model="newWorkflow.commentLanguage" placeholder="é»˜è®¤ï¼šä¸­æ–‡" clearable style="width: 100%">
                            <el-option label="ä¸­æ–‡" value="ä¸­æ–‡"></el-option>
                            <el-option label="è‹±æ–‡" value="è‹±æ–‡"></el-option>
                        </el-select>
                    </el-form-item>

                    <el-row :gutter="20">
                        <el-col :span="12">
                            <el-form-item label="æ–¹æ³•æœ€å¤§è¡Œæ•°">
                                <el-input-number v-model="newWorkflow.maxMethodLines" :min="10" :max="100" placeholder="é»˜è®¤ï¼š50"></el-input-number>
                            </el-form-item>
                        </el-col>
                        <el-col :span="12">
                            <el-form-item label="å‚æ•°æœ€å¤§ä¸ªæ•°">
                                <el-input-number v-model="newWorkflow.maxParameters" :min="1" :max="10" placeholder="é»˜è®¤ï¼š5"></el-input-number>
                            </el-form-item>
                        </el-col>
                    </el-row>
                </el-form>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="showCreateWorkflowDialog = false">å–æ¶ˆ</el-button>
                    <el-button type="primary" @click="createWorkflow" :loading="createWorkflowLoading">åˆ›å»ºå¹¶ç”Ÿæˆè§„æ ¼æ–‡æ¡£</el-button>
                </span>
            </el-dialog>

            <!-- å·¥ä½œæµè¯¦æƒ…å¯¹è¯æ¡† -->
            <el-dialog :title="'å·¥ä½œæµè¯¦æƒ… - ' + (currentWorkflow.name || '')"
                       :visible.sync="showWorkflowDetailDialog"
                       width="90%"
                       top="5vh">
                <el-steps :active="getWorkflowStep(currentWorkflow.status)" finish-status="success" align-center>
                    <el-step title="è§„æ ¼æ–‡æ¡£" description="ç”Ÿæˆspec.md"></el-step>
                    <el-step title="æŠ€æœ¯æ–¹æ¡ˆ" description="è®¾è®¡ä¸æ‰¹å‡†"></el-step>
                    <el-step title="ä»»åŠ¡åˆ—è¡¨" description="æ‹†åˆ†ä»»åŠ¡"></el-step>
                    <el-step title="ä»£ç ç”Ÿæˆ" description="AIç”Ÿæˆä»£ç "></el-step>
                    <el-step title="å®Œæˆ" description="å·¥ä½œæµç»“æŸ"></el-step>
                </el-steps>

                <el-tabs v-model="workflowDetailTab" style="margin-top: 20px;">
                    <!-- è§„æ ¼æ–‡æ¡£ -->
                    <el-tab-pane label="è§„æ ¼æ–‡æ¡£" name="spec">
                        <div v-if="currentWorkflow.specification">
                            <div style="margin-bottom: 15px;">
                                <el-button-group>
                                    <el-button size="small" icon="el-icon-refresh" @click="regenerateSpecification"
                                               :loading="specRegenerating"
                                               :disabled="currentWorkflow.status !== 'SPEC_GENERATED'">
                                        é‡æ–°ç”Ÿæˆè§„æ ¼æ–‡æ¡£
                                    </el-button>
                                    <el-button size="small" type="primary" @click="generateTechDesign"
                                               :loading="techDesignLoading"
                                               :disabled="currentWorkflow.status !== 'SPEC_GENERATED'">
                                        ç”ŸæˆæŠ€æœ¯æ–¹æ¡ˆ
                                    </el-button>
                                </el-button-group>
                            </div>
                            <div class="code-container">
                                <div class="code-header">
                                    <span>spec.md</span>
                                    <el-button size="mini" @click="copyContent(currentWorkflow.specification.content)">å¤åˆ¶</el-button>
                                </div>
                                <div class="code-content review-result" v-html="renderedSpecification"></div>
                            </div>
                        </div>
                        <el-empty v-else description="è§„æ ¼æ–‡æ¡£æœªç”Ÿæˆ"></el-empty>
                    </el-tab-pane>

                    <!-- æŠ€æœ¯æ–¹æ¡ˆ -->
                    <el-tab-pane label="æŠ€æœ¯æ–¹æ¡ˆ" name="techDesign">
                        <div v-if="currentWorkflow.technicalDesign">
                            <div style="margin-bottom: 15px;">
                                <el-button-group>
                                    <el-button size="small" @click="editTechDesign"
                                               :disabled="currentWorkflow.status !== 'TECH_DESIGN_GENERATED'">
                                        ç¼–è¾‘æ–¹æ¡ˆ
                                    </el-button>
                                    <el-button size="small" type="success" @click="approveTechDesign"
                                               :loading="approveLoading"
                                               :disabled="currentWorkflow.status !== 'TECH_DESIGN_GENERATED' || currentWorkflow.technicalDesign.approved">
                                        æ‰¹å‡†æ–¹æ¡ˆ
                                    </el-button>
                                    <el-button size="small" type="primary" @click="generateTaskList"
                                               :loading="taskListLoading"
                                               :disabled="currentWorkflow.status !== 'TECH_DESIGN_APPROVED'">
                                        ç”Ÿæˆä»»åŠ¡åˆ—è¡¨
                                    </el-button>
                                </el-button-group>
                                <el-tag v-if="currentWorkflow.technicalDesign.approved" type="success" style="margin-left: 10px;">
                                    å·²æ‰¹å‡† (ç‰ˆæœ¬ {{ currentWorkflow.technicalDesign.version }})
                                </el-tag>
                            </div>
                            <div class="code-container">
                                <div class="code-header">
                                    <span>tech-design.md (ç‰ˆæœ¬: {{ currentWorkflow.technicalDesign.version }})</span>
                                    <el-button size="mini" @click="copyContent(currentWorkflow.technicalDesign.content)">å¤åˆ¶</el-button>
                                </div>
                                <div class="code-content review-result" v-html="renderedTechnicalDesign"></div>
                            </div>
                        </div>
                        <el-empty v-else description="æŠ€æœ¯æ–¹æ¡ˆæœªç”Ÿæˆ"></el-empty>
                    </el-tab-pane>

                    <!-- ä»»åŠ¡åˆ—è¡¨ -->
                    <el-tab-pane label="ä»»åŠ¡åˆ—è¡¨" name="taskList">
                        <div v-if="currentWorkflow.taskList && currentWorkflow.taskList.tasks">
                            <div style="margin-bottom: 15px;">
                                <el-button size="small" type="primary" @click="startCodeGeneration"
                                           :loading="codeGenLoading"
                                           :disabled="currentWorkflow.status !== 'TASK_LIST_GENERATED'">
                                    å¼€å§‹ä»£ç ç”Ÿæˆ
                                </el-button>
                                <span style="margin-left: 15px; color: #666;">
                                    è¿›åº¦: {{ currentWorkflow.taskList.completedTasks || 0 }} / {{ currentWorkflow.taskList.totalTasks || 0 }}
                                </span>
                            </div>
                            <el-table :data="currentWorkflow.taskList.tasks" style="width: 100%">
                                <el-table-column prop="id" label="ä»»åŠ¡ID" width="100"></el-table-column>
                                <el-table-column prop="title" label="ä»»åŠ¡æ ‡é¢˜"></el-table-column>
                                <el-table-column label="çŠ¶æ€" width="120">
                                    <template slot-scope="scope">
                                        <el-tag :type="getTaskStatusType(scope.row.status)" size="small">
                                            {{ getTaskStatusText(scope.row.status) }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="targetFile" label="ç›®æ ‡æ–‡ä»¶"></el-table-column>
                            </el-table>
                        </div>
                        <el-empty v-else description="ä»»åŠ¡åˆ—è¡¨æœªç”Ÿæˆ"></el-empty>
                    </el-tab-pane>

                    <!-- ç”Ÿæˆä»£ç  -->
                    <el-tab-pane label="ç”Ÿæˆä»£ç " name="code">
                        <div v-if="currentWorkflow.taskList && currentWorkflow.taskList.tasks">
                            <el-collapse accordion>
                                <el-collapse-item v-for="task in completedTasks" :key="task.id" :title="task.id + ' - ' + task.title">
                                    <div class="code-container">
                                        <div class="code-header">
                                            <span>{{ task.targetFile }}</span>
                                            <el-button size="mini" @click="copyContent(task.generatedCode)">å¤åˆ¶ä»£ç </el-button>
                                        </div>
                                        <pre class="code-content">{{ task.generatedCode }}</pre>
                                    </div>
                                </el-collapse-item>
                            </el-collapse>
                            <el-empty v-if="completedTasks.length === 0" description="æš‚æ— å·²ç”Ÿæˆçš„ä»£ç "></el-empty>
                        </div>
                        <el-empty v-else description="ä»»åŠ¡åˆ—è¡¨æœªç”Ÿæˆ"></el-empty>
                    </el-tab-pane>
                </el-tabs>
            </el-dialog>

            <!-- ç¼–è¾‘æŠ€æœ¯æ–¹æ¡ˆå¯¹è¯æ¡† -->
            <el-dialog title="ç¼–è¾‘æŠ€æœ¯æ–¹æ¡ˆ" :visible.sync="showEditTechDesignDialog" width="80%">
                <el-input type="textarea" v-model="editingTechDesign" :rows="20"
                          placeholder="ç¼–è¾‘æŠ€æœ¯æ–¹æ¡ˆå†…å®¹..."></el-input>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="showEditTechDesignDialog = false">å–æ¶ˆ</el-button>
                    <el-button type="primary" @click="saveTechDesign" :loading="saveTechDesignLoading">ä¿å­˜</el-button>
                </span>
            </el-dialog>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    repositories: [],
                    branches: [],
                    testBranches: [],
                    reviewForm: {
                        repositoryId: '',
                        baseBranch: 'master',
                        targetBranch: '',
                        mode: 'deep'
                    },
                    testGenForm: {
                        repositoryId: '',
                        branch: 'master',
                        className: '',
                        gateId: '',
                        requirement: '',
                        testType: 'mock',
                        qualityLevel: 5
                    },
                    newRepository: {
                        name: '',
                        url: '',
                        username: '',
                        password: '',
                        description: ''
                    },
                    showAddDialog: false,
                    reviewLoading: false,
                    remoteLoading: false,
                    testGenLoading: false,
                    reviewResult: '',
                    currentReviewId: null,
                    exportLoading: false,
                    testGenProgress: {
                        show: false,
                        currentStep: 0,
                        percentage: 0,
                        status: '',
                        message: ''
                    },
                    testGenResult: {
                        show: false,
                        taskId: '',
                        testCode: '',
                        testFileName: '',
                        compilationSuccess: false,
                        testsPass: false,
                        coveragePercentage: 0,
                        generationTime: 0,
                        output: ''
                    },
                    // å·¥ä½œæµç›¸å…³æ•°æ®
                    activeTab: 'repos',
                    workflows: [],
                    workflowsLoading: false,
                    showCreateWorkflowDialog: false,
                    showWorkflowDetailDialog: false,
                    showEditTechDesignDialog: false,
                    createWorkflowLoading: false,
                    specRegenerating: false,
                    techDesignLoading: false,
                    approveLoading: false,
                    taskListLoading: false,
                    codeGenLoading: false,
                    saveTechDesignLoading: false,
                    newWorkflow: {
                        name: '',
                        repositoryId: '',
                        prdContent: '',
                        architecture: '',
                        codingStyle: '',
                        namingConvention: '',
                        commentLanguage: '',
                        maxMethodLines: null,
                        maxParameters: null
                    },
                    currentWorkflow: {},
                    workflowDetailTab: 'spec',
                    editingTechDesign: '',
                    workflowPollingTimer: null
                }
            },
            mounted() {
                this.loadRepositories();
                this.loadWorkflows();
            },
            beforeDestroy() {
                if (this.workflowPollingTimer) {
                    clearInterval(this.workflowPollingTimer);
                }
            },
            computed: {
                renderedReviewResult() {
                    if (!this.reviewResult) {
                        return '';
                    }
                    // ä½¿ç”¨ marked åº“æ¸²æŸ“ Markdown
                    return marked.parse(this.reviewResult);
                },
                renderedSpecification() {
                    if (!this.currentWorkflow.specification || !this.currentWorkflow.specification.content) {
                        return '';
                    }
                    return marked.parse(this.currentWorkflow.specification.content);
                },
                renderedTechnicalDesign() {
                    if (!this.currentWorkflow.technicalDesign || !this.currentWorkflow.technicalDesign.content) {
                        return '';
                    }
                    return marked.parse(this.currentWorkflow.technicalDesign.content);
                },
                completedTasks() {
                    if (!this.currentWorkflow.taskList || !this.currentWorkflow.taskList.tasks) {
                        return [];
                    }
                    return this.currentWorkflow.taskList.tasks.filter(t => t.status === 'COMPLETED' && t.generatedCode);
                }
            },
            methods: {
                async loadRepositories() {
                    try {
                        const response = await axios.get('/api/repositories');
                        console.log('Loaded repositories:', response.data);
                        this.repositories = response.data;
                    } catch (error) {
                        console.error('Failed to load repositories:', error);
                        this.$message.error('åŠ è½½ä»“åº“åˆ—è¡¨å¤±è´¥');
                    }
                },
                
                async loadBranches() {
                    if (!this.reviewForm.repositoryId) return;
                    
                    try {
                        const response = await axios.get(`/api/git/${this.reviewForm.repositoryId}/branches`);
                        // ä¿®å¤ï¼šæ­£ç¡®å¤„ç†BranchListDTOçš„æ•°æ®ç»“æ„
                        this.branches = response.data.branches || [];
                    } catch (error) {
                        this.$message.error('åŠ è½½åˆ†æ”¯åˆ—è¡¨å¤±è´¥');
                    }
                },
                
                async loadRemoteBranches() {
                    if (!this.reviewForm.repositoryId) {
                        this.$message.warning('è¯·å…ˆé€‰æ‹©ä»“åº“');
                        return;
                    }
                    
                    this.remoteLoading = true;
                    try {
                        const response = await axios.get(`/api/repositories/${this.reviewForm.repositoryId}/remote-branches`);
                        // ä¿®å¤ï¼šæ­£ç¡®å¤„ç†BranchListDTOçš„æ•°æ®ç»“æ„
                        this.branches = response.data.branches || [];
                        this.$message.success('è¿œç¨‹åˆ†æ”¯åŠ è½½æˆåŠŸ');
                    } catch (error) {
                        this.$message.error('åŠ è½½è¿œç¨‹åˆ†æ”¯å¤±è´¥: ' + (error.response?.data || error.message));
                    } finally {
                        this.remoteLoading = false;
                    }
                },
                
                async addRepository() {
                    try {
                        const response = await axios.post('/api/repositories', this.newRepository);
                        console.log('Repository created:', response.data);
                        this.showAddDialog = false;
                        this.newRepository = { name: '', url: '', username: '', password: '', description: '' };
                        await this.loadRepositories();
                        this.$message.success('ä»“åº“æ·»åŠ æˆåŠŸ');
                    } catch (error) {
                        console.error('Failed to add repository:', error);
                        this.$message.error('æ·»åŠ ä»“åº“å¤±è´¥: ' + (error.response?.data?.message || error.message));
                    }
                },
                
                async testConnection(repository) {
                    try {
                        await axios.post(`/api/repositories/${repository.id}/test-connection`);
                        this.$message.success('è¿æ¥æµ‹è¯•æˆåŠŸ');
                    } catch (error) {
                        this.$message.error('è¿æ¥æµ‹è¯•å¤±è´¥');
                    }
                },
                
                async deleteRepository(id) {
                    try {
                        await axios.delete(`/api/repositories/${id}`);
                        this.loadRepositories();
                        this.$message.success('åˆ é™¤æˆåŠŸ');
                    } catch (error) {
                        this.$message.error('åˆ é™¤å¤±è´¥');
                    }
                },
                
                async startReview() {
                    if (!this.reviewForm.repositoryId || !this.reviewForm.targetBranch) {
                        this.$message.warning('è¯·é€‰æ‹©ä»“åº“å’Œåˆ†æ”¯');
                        return;
                    }

                    this.reviewLoading = true;
                    this.reviewResult = '';
                    this.currentReviewId = null;

                    try {
                        // ä¿®å¤ï¼šä½¿ç”¨POSTè¯·æ±‚å¹¶é€šè¿‡FormDataä¼ é€’å‚æ•°
                        const params = new URLSearchParams();
                        params.append('baseBranch', this.reviewForm.baseBranch);
                        params.append('targetBranch', this.reviewForm.targetBranch);
                        params.append('mode', this.reviewForm.mode);

                        const response = await axios.post(
                            `/api/review/${this.reviewForm.repositoryId}/claude`,
                            params,
                            {
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded'
                                }
                            }
                        );
                        this.reviewResult = response.data;
                        // ä½¿ç”¨repositoryIdä½œä¸ºä¸´æ—¶çš„reviewIdï¼ˆç”¨äºæ–‡ä»¶å‘½åï¼‰
                        this.currentReviewId = this.reviewForm.repositoryId;
                        this.$message.success('Reviewå®Œæˆ');
                    } catch (error) {
                        this.$message.error('Reviewå¤±è´¥: ' + (error.response?.data || error.message));
                    } finally {
                        this.reviewLoading = false;
                    }
                },

                // è·å–å®¡æŸ¥æ¨¡å¼è¯´æ˜
                getModeDescription(mode) {
                    const descriptions = {
                        'quick': 'å¿«é€Ÿå®¡æŸ¥ï¼šä»…å…³æ³¨å…³é”®Bugã€å®‰å…¨æ¼æ´å’Œä¸¥é‡æ€§èƒ½é—®é¢˜ï¼Œé€‚åˆæ—¥å¸¸PRå®¡æŸ¥',
                        'standard': 'æ ‡å‡†å®¡æŸ¥ï¼šå¹³è¡¡çš„å®¡æŸ¥æ·±åº¦ï¼Œè¦†ç›–å¸¸è§çš„ä»£ç è´¨é‡é—®é¢˜ï¼Œé€‚åˆåŠŸèƒ½åˆå¹¶å‰æ£€æŸ¥',
                        'deep': 'æ·±åº¦å®¡æŸ¥ï¼šå…¨é¢æ·±å…¥çš„å®¡æŸ¥ï¼ŒåŒ…å«è¯¦ç»†çš„é—®é¢˜åˆ†çº§(P0-P3)ã€ä¿®å¤å»ºè®®å’Œä»£ç ç¤ºä¾‹ï¼Œé€‚åˆç‰ˆæœ¬å‘å¸ƒå‰çš„ä¸¥æ ¼å®¡æŸ¥',
                        'security': 'å®‰å…¨å®¡æŸ¥ï¼šä¸“æ³¨äºå®‰å…¨æ¼æ´æ£€æµ‹ï¼ŒåŒ…æ‹¬SQLæ³¨å…¥ã€XSSã€CSRFã€è®¤è¯æˆæƒç­‰é—®é¢˜',
                        'performance': 'æ€§èƒ½å®¡æŸ¥ï¼šä¸“æ³¨äºæ€§èƒ½é—®é¢˜ï¼ŒåŒ…æ‹¬N+1æŸ¥è¯¢ã€æ…¢SQLã€å†…å­˜æ³„æ¼ã€èµ„æºæœªå…³é—­ç­‰',
                        'architecture': 'æ¶æ„å®¡æŸ¥ï¼šå…³æ³¨æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬åˆ†å±‚è€¦åˆã€SOLIDåŸåˆ™ã€è®¾è®¡æ¨¡å¼åº”ç”¨ç­‰'
                    };
                    return descriptions[mode] || '';
                },

                // å¯¼å‡ºMarkdownæ ¼å¼æŠ¥å‘Š
                async exportMarkdown() {
                    if (!this.reviewResult) {
                        this.$message.warning('æ²¡æœ‰å¯å¯¼å‡ºçš„å®¡æŸ¥ç»“æœ');
                        return;
                    }

                    this.exportLoading = true;
                    try {
                        // åˆ›å»ºMarkdownå†…å®¹
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                        const filename = `review-${this.currentReviewId}-${timestamp}.md`;

                        // æ„å»ºå®Œæ•´çš„Markdownå†…å®¹
                        const repoName = this.repositories.find(r => r.id === this.reviewForm.repositoryId)?.name || 'Unknown';
                        const markdown = `# ä»£ç å®¡æŸ¥æŠ¥å‘Š

## åŸºæœ¬ä¿¡æ¯

- **ä»“åº“**: ${repoName}
- **åˆ†æ”¯**: ${this.reviewForm.baseBranch} â†’ ${this.reviewForm.targetBranch}
- **å®¡æŸ¥æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}

---

## å®¡æŸ¥ç»“æœ

${this.reviewResult}

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
**ç”Ÿæˆå·¥å…·**: Git Review Service
`;

                        // åˆ›å»ºBlobå¹¶ä¸‹è½½
                        const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);

                        this.$message.success('MarkdownæŠ¥å‘Šå·²å¯¼å‡º');
                    } catch (error) {
                        this.$message.error('å¯¼å‡ºå¤±è´¥: ' + error.message);
                    } finally {
                        this.exportLoading = false;
                    }
                },

                // å¯¼å‡ºJSONæ ¼å¼æŠ¥å‘Š
                async exportJson() {
                    if (!this.reviewResult) {
                        this.$message.warning('æ²¡æœ‰å¯å¯¼å‡ºçš„å®¡æŸ¥ç»“æœ');
                        return;
                    }

                    this.exportLoading = true;
                    try {
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                        const filename = `review-${this.currentReviewId}-${timestamp}.json`;

                        const repoName = this.repositories.find(r => r.id === this.reviewForm.repositoryId)?.name || 'Unknown';

                        // æ„å»ºJSONæ•°æ®
                        const jsonData = {
                            reviewId: this.currentReviewId,
                            repository: {
                                id: this.reviewForm.repositoryId,
                                name: repoName
                            },
                            branches: {
                                base: this.reviewForm.baseBranch,
                                target: this.reviewForm.targetBranch
                            },
                            reviewTime: new Date().toISOString(),
                            result: this.reviewResult,
                            metadata: {
                                generatedBy: 'Git Review Service',
                                version: '1.0.0'
                            }
                        };

                        // åˆ›å»ºBlobå¹¶ä¸‹è½½
                        const blob = new Blob([JSON.stringify(jsonData, null, 2)], {
                            type: 'application/json;charset=utf-8'
                        });
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);

                        this.$message.success('JSONæŠ¥å‘Šå·²å¯¼å‡º');
                    } catch (error) {
                        this.$message.error('å¯¼å‡ºå¤±è´¥: ' + error.message);
                    } finally {
                        this.exportLoading = false;
                    }
                },

                // æµ‹è¯•ç”Ÿæˆç›¸å…³æ–¹æ³•
                async loadTestBranches() {
                    if (!this.testGenForm.repositoryId) return;

                    try {
                        const response = await axios.get(`/api/git/${this.testGenForm.repositoryId}/branches`);
                        // ä¿®å¤ï¼šæ­£ç¡®å¤„ç†BranchListDTOçš„æ•°æ®ç»“æ„
                        this.testBranches = response.data.branches || [];
                    } catch (error) {
                        this.$message.error('åŠ è½½åˆ†æ”¯åˆ—è¡¨å¤±è´¥');
                    }
                },

                formatQualityTooltip(val) {
                    const levels = {
                        1: 'åŸºç¡€',
                        2: 'è‰¯å¥½',
                        3: 'æ ‡å‡†',
                        4: 'é«˜è´¨é‡',
                        5: 'å®Œç¾'
                    };
                    return levels[val] || 'æ ‡å‡†';
                },

                resetTestForm() {
                    this.testGenForm = {
                        repositoryId: '',
                        branch: 'master',
                        className: '',
                        gateId: '',
                        requirement: '',
                        testType: 'mock',
                        qualityLevel: 5
                    };
                    this.testGenProgress.show = false;
                    this.testGenResult.show = false;
                },

                async startTestGeneration() {
                    if (!this.testGenForm.repositoryId || !this.testGenForm.branch || !this.testGenForm.className) {
                        this.$message.warning('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                        return;
                    }

                    this.testGenLoading = true;
                    this.testGenProgress.show = true;
                    this.testGenProgress.currentStep = 0;
                    this.testGenProgress.percentage = 0;
                    this.testGenProgress.status = 'active';
                    this.testGenProgress.message = 'æ­£åœ¨åˆ†ææºç ...';
                    this.testGenResult.show = false;

                    try {
                        // è°ƒç”¨æµ‹è¯•ç”ŸæˆAPI
                        const response = await axios.post('/api/test-generation/generate', {
                            repositoryId: this.testGenForm.repositoryId,
                            branch: this.testGenForm.branch,
                            className: this.testGenForm.className,
                            gateId: this.testGenForm.gateId,
                            requirement: this.testGenForm.requirement,
                            testType: this.testGenForm.testType,
                            qualityLevel: this.testGenForm.qualityLevel
                        });

                        const taskId = response.data.taskId;

                        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
                        await this.pollTaskStatus(taskId);

                    } catch (error) {
                        this.testGenProgress.status = 'exception';
                        this.testGenProgress.message = 'ç”Ÿæˆå¤±è´¥: ' + (error.response?.data?.message || error.message);
                        this.$message.error('æµ‹è¯•ç”Ÿæˆå¤±è´¥');
                    } finally {
                        this.testGenLoading = false;
                    }
                },

                async pollTaskStatus(taskId) {
                    const pollInterval = 2000; // 2ç§’è½®è¯¢ä¸€æ¬¡
                    const maxPolls = 150; // æœ€å¤šè½®è¯¢5åˆ†é’Ÿ
                    let pollCount = 0;

                    const poll = async () => {
                        if (pollCount >= maxPolls) {
                            this.testGenProgress.status = 'exception';
                            this.testGenProgress.message = 'ç”Ÿæˆè¶…æ—¶';
                            return;
                        }

                        try {
                            const response = await axios.get(`/api/test-generation/status/${taskId}`);
                            const status = response.data;

                            // æ›´æ–°è¿›åº¦
                            this.updateProgress(status);

                            if (status.status === 'COMPLETED') {
                                // è·å–æœ€ç»ˆç»“æœ
                                await this.loadFinalResult(taskId);
                                return;
                            } else if (status.status === 'FAILED') {
                                this.testGenProgress.status = 'exception';
                                this.testGenProgress.message = 'ç”Ÿæˆå¤±è´¥: ' + status.message;
                                return;
                            }

                            // ç»§ç»­è½®è¯¢
                            pollCount++;
                            setTimeout(poll, pollInterval);

                        } catch (error) {
                            this.testGenProgress.status = 'exception';
                            this.testGenProgress.message = 'çŠ¶æ€æŸ¥è¯¢å¤±è´¥';
                        }
                    };

                    await poll();
                },

                updateProgress(status) {
                    const stepMap = {
                        'ANALYZING': { step: 0, message: 'æ­£åœ¨åˆ†æJavaç±»ç»“æ„...', percentage: 25 },
                        'GENERATING': { step: 1, message: 'æ­£åœ¨ç”Ÿæˆæµ‹è¯•ä»£ç ...', percentage: 50 },
                        'COMPILING': { step: 2, message: 'æ­£åœ¨éªŒè¯ç¼–è¯‘...', percentage: 75 },
                        'TESTING': { step: 3, message: 'æ­£åœ¨æ‰§è¡Œæµ‹è¯•...', percentage: 90 },
                        'COMPLETED': { step: 4, message: 'ç”Ÿæˆå®Œæˆ', percentage: 100 }
                    };

                    const progress = stepMap[status.status] || { step: 0, message: status.message, percentage: 0 };

                    this.testGenProgress.currentStep = progress.step;
                    this.testGenProgress.percentage = progress.percentage;
                    this.testGenProgress.message = progress.message;

                    if (status.status === 'COMPLETED') {
                        this.testGenProgress.status = 'success';
                    }
                },

                async loadFinalResult(taskId) {
                    try {
                        const response = await axios.get(`/api/test-generation/result/${taskId}`);
                        const result = response.data;

                        this.testGenResult = {
                            show: true,
                            taskId: taskId,
                            testCode: result.testCode,
                            testFileName: result.testFileName,
                            compilationSuccess: result.compilationSuccess,
                            testsPass: result.testsPass,
                            coveragePercentage: result.coveragePercentage || 0,
                            generationTime: result.generationTime || 0,
                            output: result.output || ''
                        };

                        this.$message.success('æµ‹è¯•ä»£ç ç”Ÿæˆå®Œæˆï¼');
                    } catch (error) {
                        this.$message.error('è·å–ç»“æœå¤±è´¥');
                    }
                },

                copyTestCode() {
                    if (!this.testGenResult.testCode) return;

                    // åˆ›å»ºä¸´æ—¶textareaå…ƒç´ å¤åˆ¶æ–‡æœ¬
                    const textarea = document.createElement('textarea');
                    textarea.value = this.testGenResult.testCode;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);

                    this.$message.success('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                },

                downloadTestCode() {
                    if (!this.testGenResult.testCode) return;

                    const blob = new Blob([this.testGenResult.testCode], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = this.testGenResult.testFileName || 'TestClass.java';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    this.$message.success('æ–‡ä»¶ä¸‹è½½å®Œæˆ');
                },

                // ========== å·¥ä½œæµç›¸å…³æ–¹æ³• ==========
                async loadWorkflows() {
                    this.workflowsLoading = true;
                    try {
                        const response = await axios.get('/api/workflow');
                        this.workflows = response.data;
                    } catch (error) {
                        this.$message.error('åŠ è½½å·¥ä½œæµåˆ—è¡¨å¤±è´¥');
                    } finally {
                        this.workflowsLoading = false;
                    }
                },

                async createWorkflow() {
                    if (!this.newWorkflow.name || !this.newWorkflow.repositoryId || !this.newWorkflow.prdContent) {
                        this.$message.warning('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
                        return;
                    }

                    this.createWorkflowLoading = true;
                    try {
                        // 1. åˆ›å»ºå·¥ä½œæµï¼ˆåŒ…å«ä»£ç é£æ ¼é…ç½®ï¼‰
                        const createPayload = {
                            name: this.newWorkflow.name,
                            repositoryId: this.newWorkflow.repositoryId,
                            createdBy: 'user'
                        };

                        // æ·»åŠ å¯é€‰çš„ä»£ç é£æ ¼é…ç½®
                        if (this.newWorkflow.architecture) {
                            createPayload.architecture = this.newWorkflow.architecture;
                        }
                        if (this.newWorkflow.codingStyle) {
                            createPayload.codingStyle = this.newWorkflow.codingStyle;
                        }
                        if (this.newWorkflow.namingConvention) {
                            createPayload.namingConvention = this.newWorkflow.namingConvention;
                        }
                        if (this.newWorkflow.commentLanguage) {
                            createPayload.commentLanguage = this.newWorkflow.commentLanguage;
                        }
                        if (this.newWorkflow.maxMethodLines) {
                            createPayload.maxMethodLines = this.newWorkflow.maxMethodLines;
                        }
                        if (this.newWorkflow.maxParameters) {
                            createPayload.maxParameters = this.newWorkflow.maxParameters;
                        }

                        const createRes = await axios.post('/api/workflow', createPayload);
                        const workflowId = createRes.data.workflowId;

                        // 2. ç”Ÿæˆè§„æ ¼æ–‡æ¡£
                        await axios.post(`/api/workflow/${workflowId}/spec/generate`, {
                            prdContent: this.newWorkflow.prdContent,
                            documentPaths: []
                        });

                        this.$message.success('å·¥ä½œæµåˆ›å»ºæˆåŠŸï¼Œæ­£åœ¨ç”Ÿæˆè§„æ ¼æ–‡æ¡£...');
                        this.showCreateWorkflowDialog = false;
                        this.newWorkflow = {
                            name: '',
                            repositoryId: '',
                            prdContent: '',
                            architecture: '',
                            codingStyle: '',
                            namingConvention: '',
                            commentLanguage: '',
                            maxMethodLines: null,
                            maxParameters: null
                        };

                        // åˆ·æ–°åˆ—è¡¨
                        await this.loadWorkflows();

                        // å¼€å¯è½®è¯¢
                        this.startPollingWorkflow(workflowId);
                    } catch (error) {
                        this.$message.error('åˆ›å»ºå·¥ä½œæµå¤±è´¥: ' + (error.response?.data?.message || error.message));
                    } finally {
                        this.createWorkflowLoading = false;
                    }
                },

                async viewWorkflowDetail(workflow) {
                    try {
                        // è·å–å®Œæ•´çš„å·¥ä½œæµè¯¦æƒ…
                        const promises = [
                            axios.get(`/api/workflow/${workflow.id}/status`)
                        ];

                        // æ ¹æ®çŠ¶æ€è·å–ä¸åŒçš„æ•°æ®
                        if (workflow.status !== 'DRAFT' && workflow.status !== 'SPEC_GENERATING') {
                            promises.push(axios.get(`/api/workflow/${workflow.id}/spec`).catch(() => null));
                        }
                        if (['TECH_DESIGN_GENERATED', 'TECH_DESIGN_APPROVED', 'TASK_LIST_GENERATING', 'TASK_LIST_GENERATED', 'CODE_GENERATING', 'COMPLETED'].includes(workflow.status)) {
                            promises.push(axios.get(`/api/workflow/${workflow.id}/tech-design`).catch(() => null));
                        }
                        if (['TASK_LIST_GENERATED', 'CODE_GENERATING', 'COMPLETED'].includes(workflow.status)) {
                            promises.push(axios.get(`/api/workflow/${workflow.id}/tasklist`).catch(() => null));
                        }

                        const results = await Promise.all(promises);

                        this.currentWorkflow = {
                            ...results[0].data,
                            specification: results[1]?.data || null,
                            technicalDesign: results[2]?.data || null,
                            taskList: results[3]?.data || null
                        };

                        this.showWorkflowDetailDialog = true;

                        // å¦‚æœå·¥ä½œæµæ­£åœ¨è¿›è¡Œä¸­ï¼Œå¼€å¯è½®è¯¢
                        if (!['COMPLETED', 'FAILED', 'CANCELLED'].includes(workflow.status)) {
                            this.startPollingWorkflow(workflow.id);
                        }
                    } catch (error) {
                        this.$message.error('è·å–å·¥ä½œæµè¯¦æƒ…å¤±è´¥');
                    }
                },

                continueWorkflow(workflow) {
                    this.viewWorkflowDetail(workflow);
                },

                async cancelWorkflow(workflow) {
                    try {
                        await this.$confirm('ç¡®å®šè¦å–æ¶ˆè¯¥å·¥ä½œæµå—ï¼Ÿ', 'æç¤º', {
                            confirmButtonText: 'ç¡®å®š',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning'
                        });

                        await axios.post(`/api/workflow/${workflow.id}/cancel`, { reason: 'ç”¨æˆ·æ‰‹åŠ¨å–æ¶ˆ' });
                        this.$message.success('å·¥ä½œæµå·²å–æ¶ˆ');
                        await this.loadWorkflows();
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.$message.error('å–æ¶ˆå·¥ä½œæµå¤±è´¥');
                        }
                    }
                },

                async regenerateSpecification() {
                    try {
                        const result = await this.$confirm('ç¡®è®¤é‡æ–°ç”Ÿæˆè§„æ ¼æ–‡æ¡£å—ï¼Ÿå°†ä½¿ç”¨åŸæœ‰PRDå†…å®¹é‡æ–°ç”Ÿæˆã€‚', 'æç¤º', {
                            confirmButtonText: 'ç¡®å®š',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning'
                        });

                        this.specRegenerating = true;
                        await axios.post(`/api/workflow/${this.currentWorkflow.id}/spec/generate`, {
                            prdContent: this.currentWorkflow.specification.prdContent,
                            documentPaths: this.currentWorkflow.specification.documentPaths || []
                        });
                        this.$message.success('è§„æ ¼æ–‡æ¡£é‡æ–°ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...');
                        this.startPollingWorkflow(this.currentWorkflow.id);
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.$message.error('é‡æ–°ç”Ÿæˆè§„æ ¼æ–‡æ¡£å¤±è´¥');
                        }
                    } finally {
                        this.specRegenerating = false;
                    }
                },

                async generateTechDesign() {
                    this.techDesignLoading = true;
                    try {
                        await axios.post(`/api/workflow/${this.currentWorkflow.id}/tech-design/generate`);
                        this.$message.success('æŠ€æœ¯æ–¹æ¡ˆç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...');
                        this.startPollingWorkflow(this.currentWorkflow.id);
                    } catch (error) {
                        this.$message.error('ç”ŸæˆæŠ€æœ¯æ–¹æ¡ˆå¤±è´¥');
                    } finally {
                        this.techDesignLoading = false;
                    }
                },

                editTechDesign() {
                    this.editingTechDesign = this.currentWorkflow.technicalDesign.content;
                    this.showEditTechDesignDialog = true;
                },

                async saveTechDesign() {
                    this.saveTechDesignLoading = true;
                    try {
                        await axios.put(`/api/workflow/${this.currentWorkflow.id}/tech-design`, {
                            content: this.editingTechDesign
                        });
                        this.$message.success('æŠ€æœ¯æ–¹æ¡ˆå·²æ›´æ–°');
                        this.showEditTechDesignDialog = false;
                        await this.viewWorkflowDetail(this.currentWorkflow);
                    } catch (error) {
                        this.$message.error('ä¿å­˜å¤±è´¥');
                    } finally {
                        this.saveTechDesignLoading = false;
                    }
                },

                async approveTechDesign() {
                    this.approveLoading = true;
                    try {
                        await axios.post(`/api/workflow/${this.currentWorkflow.id}/tech-design/approve`);
                        this.$message.success('æŠ€æœ¯æ–¹æ¡ˆå·²æ‰¹å‡†');
                        await this.viewWorkflowDetail(this.currentWorkflow);
                    } catch (error) {
                        this.$message.error('æ‰¹å‡†å¤±è´¥');
                    } finally {
                        this.approveLoading = false;
                    }
                },

                async generateTaskList() {
                    this.taskListLoading = true;
                    try {
                        await axios.post(`/api/workflow/${this.currentWorkflow.id}/tasklist/generate`);
                        this.$message.success('ä»»åŠ¡åˆ—è¡¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...');
                        this.startPollingWorkflow(this.currentWorkflow.id);
                    } catch (error) {
                        this.$message.error('ç”Ÿæˆä»»åŠ¡åˆ—è¡¨å¤±è´¥');
                    } finally {
                        this.taskListLoading = false;
                    }
                },

                async startCodeGeneration() {
                    this.codeGenLoading = true;
                    try {
                        await axios.post(`/api/workflow/${this.currentWorkflow.id}/code-generation/start`);
                        this.$message.success('ä»£ç ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...');
                        this.startPollingWorkflow(this.currentWorkflow.id);
                    } catch (error) {
                        this.$message.error('å¼€å§‹ä»£ç ç”Ÿæˆå¤±è´¥');
                    } finally {
                        this.codeGenLoading = false;
                    }
                },

                startPollingWorkflow(workflowId) {
                    if (this.workflowPollingTimer) {
                        clearInterval(this.workflowPollingTimer);
                    }

                    this.workflowPollingTimer = setInterval(async () => {
                        try {
                            const res = await axios.get(`/api/workflow/${workflowId}/status`);
                            const status = res.data.status;

                            // æ›´æ–°åˆ—è¡¨
                            await this.loadWorkflows();

                            // å¦‚æœè¯¦æƒ…å¯¹è¯æ¡†æ‰“å¼€ä¸”æ˜¯å½“å‰å·¥ä½œæµï¼Œåˆ™åˆ·æ–°è¯¦æƒ…
                            if (this.showWorkflowDetailDialog && this.currentWorkflow.id === workflowId) {
                                await this.viewWorkflowDetail({ id: workflowId, status });
                            }

                            // å¦‚æœå·²å®Œæˆï¼Œåœæ­¢è½®è¯¢
                            if (['COMPLETED', 'FAILED', 'CANCELLED'].includes(status)) {
                                clearInterval(this.workflowPollingTimer);
                                this.workflowPollingTimer = null;
                            }
                        } catch (error) {
                            console.error('è½®è¯¢å·¥ä½œæµçŠ¶æ€å¤±è´¥', error);
                        }
                    }, 3000);
                },

                copyContent(content) {
                    const textarea = document.createElement('textarea');
                    textarea.value = content;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    this.$message.success('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                },

                getStatusType(status) {
                    const typeMap = {
                        'DRAFT': 'info',
                        'SPEC_GENERATING': 'warning',
                        'SPEC_GENERATED': 'success',
                        'TECH_DESIGN_GENERATING': 'warning',
                        'TECH_DESIGN_GENERATED': 'success',
                        'TECH_DESIGN_APPROVED': 'success',
                        'TASK_LIST_GENERATING': 'warning',
                        'TASK_LIST_GENERATED': 'success',
                        'CODE_GENERATING': 'warning',
                        'COMPLETED': 'success',
                        'FAILED': 'danger',
                        'CANCELLED': 'info'
                    };
                    return typeMap[status] || 'info';
                },

                getStatusText(status) {
                    const textMap = {
                        'DRAFT': 'è‰ç¨¿',
                        'SPEC_GENERATING': 'ç”Ÿæˆè§„æ ¼æ–‡æ¡£ä¸­',
                        'SPEC_GENERATED': 'è§„æ ¼æ–‡æ¡£å·²ç”Ÿæˆ',
                        'TECH_DESIGN_GENERATING': 'ç”ŸæˆæŠ€æœ¯æ–¹æ¡ˆä¸­',
                        'TECH_DESIGN_GENERATED': 'æŠ€æœ¯æ–¹æ¡ˆå·²ç”Ÿæˆ',
                        'TECH_DESIGN_APPROVED': 'æŠ€æœ¯æ–¹æ¡ˆå·²æ‰¹å‡†',
                        'TASK_LIST_GENERATING': 'ç”Ÿæˆä»»åŠ¡åˆ—è¡¨ä¸­',
                        'TASK_LIST_GENERATED': 'ä»»åŠ¡åˆ—è¡¨å·²ç”Ÿæˆ',
                        'CODE_GENERATING': 'ä»£ç ç”Ÿæˆä¸­',
                        'COMPLETED': 'å·²å®Œæˆ',
                        'FAILED': 'å¤±è´¥',
                        'CANCELLED': 'å·²å–æ¶ˆ'
                    };
                    return textMap[status] || status;
                },

                getTaskStatusType(status) {
                    const typeMap = {
                        'PENDING': 'info',
                        'IN_PROGRESS': 'warning',
                        'COMPLETED': 'success',
                        'FAILED': 'danger',
                        'SKIPPED': 'info'
                    };
                    return typeMap[status] || 'info';
                },

                getTaskStatusText(status) {
                    const textMap = {
                        'PENDING': 'å¾…æ‰§è¡Œ',
                        'IN_PROGRESS': 'è¿›è¡Œä¸­',
                        'COMPLETED': 'å·²å®Œæˆ',
                        'FAILED': 'å¤±è´¥',
                        'SKIPPED': 'å·²è·³è¿‡'
                    };
                    return textMap[status] || status;
                },

                getProgressColor(percentage) {
                    if (percentage < 30) return '#f56c6c';
                    if (percentage < 70) return '#e6a23c';
                    return '#67c23a';
                },

                getWorkflowStep(status) {
                    const stepMap = {
                        'DRAFT': 0,
                        'SPEC_GENERATING': 0,
                        'SPEC_GENERATED': 1,
                        'TECH_DESIGN_GENERATING': 1,
                        'TECH_DESIGN_GENERATED': 2,
                        'TECH_DESIGN_APPROVED': 2,
                        'TASK_LIST_GENERATING': 2,
                        'TASK_LIST_GENERATED': 3,
                        'CODE_GENERATING': 3,
                        'COMPLETED': 4,
                        'FAILED': -1,
                        'CANCELLED': -1
                    };
                    return stepMap[status] || 0;
                },

                canContinue(workflow) {
                    return !['COMPLETED', 'FAILED', 'CANCELLED'].includes(workflow.status);
                },

                canCancel(workflow) {
                    return !['COMPLETED', 'FAILED', 'CANCELLED'].includes(workflow.status);
                },

                formatDate(dateStr) {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return date.toLocaleString('zh-CN');
                }
            }
        });
    </script>
</body>
</html>