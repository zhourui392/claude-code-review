<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gitä»£ç ReviewæœåŠ¡</title>
    <link href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
        }
        .review-result {
            background: #f5f7fa;
            padding: 20px;
            border-radius: 4px;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        .test-progress {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e6e6e6;
        }
        .test-result {
            margin-top: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e6e6e6;
        }
        .code-container {
            border: 1px solid #e6e6e6;
            border-radius: 4px;
            overflow: hidden;
        }
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f8f8;
            border-bottom: 1px solid #e6e6e6;
            font-weight: bold;
        }
        .code-content {
            background: #f5f5f5;
            padding: 15px;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
        }
        .test-output {
            margin-top: 15px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 4px;
            border: 1px solid #e6e6e6;
        }
        .test-output pre {
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.3;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>Gitä»£ç ReviewæœåŠ¡</h1>
                <p>ä½¿ç”¨Claude AIè¿›è¡Œè‡ªåŠ¨åŒ–ä»£ç å®¡æŸ¥</p>
            </div>

            <el-tabs type="border-card">
                <el-tab-pane label="ä»“åº“ç®¡ç†">
                    <div class="section">
                        <h3>Gitä»“åº“é…ç½®</h3>
                        <el-button type="primary" @click="showAddDialog = true">æ·»åŠ ä»“åº“</el-button>
                        
                        <el-table :data="repositories" style="width: 100%; margin-top: 20px;">
                            <el-table-column prop="name" label="ä»“åº“åç§°"></el-table-column>
                            <el-table-column prop="repositoryUrl" label="ä»“åº“åœ°å€"></el-table-column>
                            <el-table-column prop="description" label="æè¿°"></el-table-column>
                            <el-table-column label="æ“ä½œ" width="200">
                                <template slot-scope="scope">
                                    <el-button size="mini" @click="testConnection(scope.row)">æµ‹è¯•è¿æ¥</el-button>
                                    <el-button size="mini" type="danger" @click="deleteRepository(scope.row.id)">åˆ é™¤</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>
                </el-tab-pane>

                <el-tab-pane label="ä»£ç Review">
                    <div class="section">
                        <h3>ä»£ç å®¡æŸ¥</h3>
                        
                        <el-form :model="reviewForm" label-width="120px">
                            <el-form-item label="é€‰æ‹©ä»“åº“">
                                <el-select v-model="reviewForm.repositoryId" placeholder="è¯·é€‰æ‹©ä»“åº“" @change="loadBranches">
                                    <el-option v-for="repo in repositories" 
                                               :key="repo.id" 
                                               :label="repo.name" 
                                               :value="repo.id">
                                    </el-option>
                                </el-select>
                                <el-button style="margin-left: 10px" @click="loadRemoteBranches" :loading="remoteLoading">
                                    ä»è¿œç¨‹æ‹‰å–åˆ†æ”¯
                                </el-button>
                            </el-form-item>

                            <el-form-item label="åŸºç¡€åˆ†æ”¯">
                                <el-select v-model="reviewForm.baseBranch" placeholder="è¯·é€‰æ‹©åŸºç¡€åˆ†æ”¯" filterable allow-create>
                                    <el-option v-for="branch in branches" 
                                               :key="'base-' + branch" 
                                               :label="branch" 
                                               :value="branch">
                                    </el-option>
                                </el-select>
                            </el-form-item>
                            
                            <el-form-item label="ç›®æ ‡åˆ†æ”¯">
                                <el-select v-model="reviewForm.targetBranch" placeholder="è¯·é€‰æ‹©ç›®æ ‡åˆ†æ”¯" filterable allow-create>
                                    <el-option v-for="branch in branches"
                                               :key="'target-' + branch"
                                               :label="branch"
                                               :value="branch">
                                    </el-option>
                                </el-select>
                            </el-form-item>

                            <el-form-item label="å®¡æŸ¥æ¨¡å¼">
                                <el-select v-model="reviewForm.mode" placeholder="è¯·é€‰æ‹©å®¡æŸ¥æ¨¡å¼">
                                    <el-option label="âš¡ å¿«é€Ÿå®¡æŸ¥ (2-5åˆ†é’Ÿ)" value="quick">
                                        <span style="float: left">âš¡ å¿«é€Ÿå®¡æŸ¥</span>
                                        <span style="float: right; color: #8492a6; font-size: 13px">2-5åˆ†é’Ÿ</span>
                                    </el-option>
                                    <el-option label="ğŸ“‹ æ ‡å‡†å®¡æŸ¥ (5-10åˆ†é’Ÿ)" value="standard">
                                        <span style="float: left">ğŸ“‹ æ ‡å‡†å®¡æŸ¥</span>
                                        <span style="float: right; color: #8492a6; font-size: 13px">5-10åˆ†é’Ÿ</span>
                                    </el-option>
                                    <el-option label="ğŸ” æ·±åº¦å®¡æŸ¥ (10-20åˆ†é’Ÿ)" value="deep">
                                        <span style="float: left">ğŸ” æ·±åº¦å®¡æŸ¥</span>
                                        <span style="float: right; color: #8492a6; font-size: 13px">10-20åˆ†é’Ÿ</span>
                                    </el-option>
                                    <el-option label="ğŸ”’ å®‰å…¨å®¡æŸ¥ (5-10åˆ†é’Ÿ)" value="security">
                                        <span style="float: left">ğŸ”’ å®‰å…¨å®¡æŸ¥</span>
                                        <span style="float: right; color: #8492a6; font-size: 13px">5-10åˆ†é’Ÿ</span>
                                    </el-option>
                                    <el-option label="âš¡ æ€§èƒ½å®¡æŸ¥ (5-10åˆ†é’Ÿ)" value="performance">
                                        <span style="float: left">âš¡ æ€§èƒ½å®¡æŸ¥</span>
                                        <span style="float: right; color: #8492a6; font-size: 13px">5-10åˆ†é’Ÿ</span>
                                    </el-option>
                                    <el-option label="ğŸ—ï¸ æ¶æ„å®¡æŸ¥ (5-10åˆ†é’Ÿ)" value="architecture">
                                        <span style="float: left">ğŸ—ï¸ æ¶æ„å®¡æŸ¥</span>
                                        <span style="float: right; color: #8492a6; font-size: 13px">5-10åˆ†é’Ÿ</span>
                                    </el-option>
                                </el-select>
                                <el-alert
                                    v-if="reviewForm.mode"
                                    :title="getModeDescription(reviewForm.mode)"
                                    type="info"
                                    :closable="false"
                                    style="margin-top: 10px">
                                </el-alert>
                            </el-form-item>

                            <el-form-item>
                                <el-button type="primary" @click="startReview" :loading="reviewLoading">
                                    å¼€å§‹Review
                                </el-button>
                            </el-form-item>
                        </el-form>

                        <div v-if="reviewResult" class="review-result">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0;">Reviewç»“æœï¼š</h4>
                                <el-button-group v-if="currentReviewId">
                                    <el-button
                                        size="small"
                                        icon="el-icon-download"
                                        @click="exportMarkdown"
                                        :loading="exportLoading">
                                        å¯¼å‡º Markdown
                                    </el-button>
                                    <el-button
                                        size="small"
                                        icon="el-icon-document"
                                        @click="exportJson"
                                        :loading="exportLoading">
                                        å¯¼å‡º JSON
                                    </el-button>
                                </el-button-group>
                            </div>
                            <div>{{ reviewResult }}</div>
                        </div>
                    </div>
                </el-tab-pane>

                <el-tab-pane label="å•å…ƒæµ‹è¯•ç”Ÿæˆ">
                    <div class="section">
                        <h3>æ™ºèƒ½å•å…ƒæµ‹è¯•ç”Ÿæˆ</h3>

                        <el-form :model="testGenForm" label-width="120px">
                            <el-form-item label="é€‰æ‹©ä»“åº“">
                                <el-select v-model="testGenForm.repositoryId" placeholder="è¯·é€‰æ‹©ä»“åº“" @change="loadTestBranches">
                                    <el-option v-for="repo in repositories"
                                               :key="repo.id"
                                               :label="repo.name"
                                               :value="repo.id">
                                    </el-option>
                                </el-select>
                            </el-form-item>

                            <el-form-item label="åˆ†æ”¯">
                                <el-select v-model="testGenForm.branch" placeholder="è¯·é€‰æ‹©åˆ†æ”¯" filterable allow-create>
                                    <el-option v-for="branch in testBranches"
                                               :key="'test-' + branch"
                                               :label="branch"
                                               :value="branch">
                                    </el-option>
                                </el-select>
                            </el-form-item>

                            <el-form-item label="Javaç±»å">
                                <el-input
                                    type="textarea"
                                    v-model="testGenForm.className"
                                    :rows="3"
                                    placeholder="ä¾‹å¦‚: UserService æˆ– UserService,OrderService,ProductService (é€—å·åˆ†éš”å¤šä¸ªç±»)">
                                </el-input>
                                <div style="color: #909399; font-size: 12px; margin-top: 5px;">
                                    æ”¯æŒè¾“å…¥å¤šä¸ªç±»åï¼Œä½¿ç”¨è‹±æ–‡é€—å·åˆ†éš”
                                </div>
                            </el-form-item>

                            <el-form-item label="å‡†å…¥ID">
                                <el-input v-model="testGenForm.gateId" placeholder="å¯é€‰ï¼Œæœªå¡«å†™åˆ™ä»Gitå†å²æå–">
                                    <template slot="prepend">Gate ID</template>
                                </el-input>
                                <div style="color: #909399; font-size: 12px; margin-top: 5px;">
                                    å¦‚ä¸å¡«å†™ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä»æœ€è¿‘çš„Gitæäº¤å†å²ä¸­æå–å‡†å…¥ID
                                </div>
                            </el-form-item>

                            <el-form-item label="æµ‹è¯•è¦æ±‚">
                                <el-input
                                    type="textarea"
                                    v-model="testGenForm.requirement"
                                    :rows="4"
                                    placeholder="å¯é€‰ï¼Œè¾“å…¥å¯¹æµ‹è¯•ä»£ç çš„ç‰¹æ®Šè¦æ±‚ï¼ˆå¦‚ï¼šéœ€è¦æµ‹è¯•è¾¹ç•Œæ¡ä»¶ã€éœ€è¦è¦†ç›–å¼‚å¸¸åœºæ™¯ç­‰ï¼‰">
                                </el-input>
                                <div style="color: #909399; font-size: 12px; margin-top: 5px;">
                                    å¯é€‰å¡«å†™ï¼Œç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤çš„Mockæµ‹è¯•æ ‡å‡†ï¼ˆå®Œç¾è´¨é‡ï¼‰
                                </div>
                            </el-form-item>

                            <el-form-item>
                                <el-button type="primary" @click="startTestGeneration" :loading="testGenLoading">
                                    ç”Ÿæˆæµ‹è¯•ä»£ç 
                                </el-button>
                                <el-button @click="resetTestForm">é‡ç½®</el-button>
                            </el-form-item>
                        </el-form>

                        <!-- è¿›åº¦æ˜¾ç¤º -->
                        <div v-if="testGenProgress.show" class="test-progress">
                            <h4>ç”Ÿæˆè¿›åº¦</h4>
                            <el-steps :active="testGenProgress.currentStep" finish-status="success">
                                <el-step title="åˆ†ææºç " description="è§£æJavaç±»ç»“æ„"></el-step>
                                <el-step title="ç”Ÿæˆæµ‹è¯•" description="Claude AIç”Ÿæˆæµ‹è¯•ä»£ç "></el-step>
                                <el-step title="éªŒè¯ç¼–è¯‘" description="æ£€æŸ¥æµ‹è¯•ä»£ç è¯­æ³•"></el-step>
                                <el-step title="æ‰§è¡Œæµ‹è¯•" description="è¿è¡Œå¹¶éªŒè¯æµ‹è¯•"></el-step>
                            </el-steps>
                            <el-progress :percentage="testGenProgress.percentage"
                                        :status="testGenProgress.status"
                                        style="margin-top: 20px;">
                            </el-progress>
                            <div v-if="testGenProgress.message" style="margin-top: 10px; color: #666;">
                                {{ testGenProgress.message }}
                            </div>
                        </div>

                        <!-- ç»“æœå±•ç¤º -->
                        <div v-if="testGenResult.show" class="test-result">
                            <h4>ç”Ÿæˆç»“æœ</h4>
                            <el-tabs type="card">
                                <el-tab-pane label="æµ‹è¯•ä»£ç ">
                                    <div class="code-container">
                                        <div class="code-header">
                                            <span>{{ testGenResult.testFileName }}</span>
                                            <div>
                                                <el-button size="mini" @click="copyTestCode">å¤åˆ¶ä»£ç </el-button>
                                                <el-button size="mini" type="primary" @click="downloadTestCode">ä¸‹è½½æ–‡ä»¶</el-button>
                                            </div>
                                        </div>
                                        <pre class="code-content"><code>{{ testGenResult.testCode }}</code></pre>
                                    </div>
                                </el-tab-pane>
                                <el-tab-pane label="æ‰§è¡Œç»“æœ">
                                    <el-descriptions border>
                                        <el-descriptions-item label="ç¼–è¯‘çŠ¶æ€">
                                            <el-tag :type="testGenResult.compilationSuccess ? 'success' : 'danger'">
                                                {{ testGenResult.compilationSuccess ? 'ç¼–è¯‘æˆåŠŸ' : 'ç¼–è¯‘å¤±è´¥' }}
                                            </el-tag>
                                        </el-descriptions-item>
                                        <el-descriptions-item label="æµ‹è¯•é€šè¿‡">
                                            <el-tag :type="testGenResult.testsPass ? 'success' : 'warning'">
                                                {{ testGenResult.testsPass ? 'å…¨éƒ¨é€šè¿‡' : 'éƒ¨åˆ†å¤±è´¥' }}
                                            </el-tag>
                                        </el-descriptions-item>
                                        <el-descriptions-item label="è¦†ç›–ç‡">
                                            <span>{{ testGenResult.coveragePercentage }}%</span>
                                        </el-descriptions-item>
                                        <el-descriptions-item label="ç”Ÿæˆæ—¶é—´">
                                            <span>{{ testGenResult.generationTime }}ç§’</span>
                                        </el-descriptions-item>
                                    </el-descriptions>
                                    <div v-if="testGenResult.output" class="test-output">
                                        <h5>æ‰§è¡Œè¾“å‡ºï¼š</h5>
                                        <pre>{{ testGenResult.output }}</pre>
                                    </div>
                                </el-tab-pane>
                            </el-tabs>
                        </div>
                    </div>
                </el-tab-pane>
            </el-tabs>

            <!-- æ·»åŠ ä»“åº“å¯¹è¯æ¡† -->
            <el-dialog title="æ·»åŠ Gitä»“åº“" :visible.sync="showAddDialog" width="500px">
                <el-form :model="newRepository" label-width="100px">
                    <el-form-item label="ä»“åº“åç§°">
                        <el-input v-model="newRepository.name"></el-input>
                    </el-form-item>
                    <el-form-item label="ä»“åº“åœ°å€">
                        <el-input v-model="newRepository.url"></el-input>
                    </el-form-item>
                    <el-form-item label="ç”¨æˆ·å">
                        <el-input v-model="newRepository.username"></el-input>
                    </el-form-item>
                    <el-form-item label="å¯†ç ">
                        <el-input v-model="newRepository.password" type="password"></el-input>
                    </el-form-item>
                    <el-form-item label="æè¿°">
                        <el-input v-model="newRepository.description" type="textarea"></el-input>
                    </el-form-item>
                </el-form>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="showAddDialog = false">å–æ¶ˆ</el-button>
                    <el-button type="primary" @click="addRepository">ç¡®å®š</el-button>
                </span>
            </el-dialog>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    repositories: [],
                    branches: [],
                    testBranches: [],
                    reviewForm: {
                        repositoryId: '',
                        baseBranch: 'master',
                        targetBranch: '',
                        mode: 'deep'
                    },
                    testGenForm: {
                        repositoryId: '',
                        branch: 'master',
                        className: '',
                        gateId: '',
                        requirement: '',
                        testType: 'mock',
                        qualityLevel: 5
                    },
                    newRepository: {
                        name: '',
                        url: '',
                        username: '',
                        password: '',
                        description: ''
                    },
                    showAddDialog: false,
                    reviewLoading: false,
                    remoteLoading: false,
                    testGenLoading: false,
                    reviewResult: '',
                    currentReviewId: null,
                    exportLoading: false,
                    testGenProgress: {
                        show: false,
                        currentStep: 0,
                        percentage: 0,
                        status: '',
                        message: ''
                    },
                    testGenResult: {
                        show: false,
                        taskId: '',
                        testCode: '',
                        testFileName: '',
                        compilationSuccess: false,
                        testsPass: false,
                        coveragePercentage: 0,
                        generationTime: 0,
                        output: ''
                    }
                }
            },
            mounted() {
                this.loadRepositories();
            },
            methods: {
                async loadRepositories() {
                    try {
                        const response = await axios.get('/api/repositories');
                        console.log('Loaded repositories:', response.data);
                        this.repositories = response.data;
                    } catch (error) {
                        console.error('Failed to load repositories:', error);
                        this.$message.error('åŠ è½½ä»“åº“åˆ—è¡¨å¤±è´¥');
                    }
                },
                
                async loadBranches() {
                    if (!this.reviewForm.repositoryId) return;
                    
                    try {
                        const response = await axios.get(`/api/git/${this.reviewForm.repositoryId}/branches`);
                        // ä¿®å¤ï¼šæ­£ç¡®å¤„ç†BranchListDTOçš„æ•°æ®ç»“æ„
                        this.branches = response.data.branches || [];
                    } catch (error) {
                        this.$message.error('åŠ è½½åˆ†æ”¯åˆ—è¡¨å¤±è´¥');
                    }
                },
                
                async loadRemoteBranches() {
                    if (!this.reviewForm.repositoryId) {
                        this.$message.warning('è¯·å…ˆé€‰æ‹©ä»“åº“');
                        return;
                    }
                    
                    this.remoteLoading = true;
                    try {
                        const response = await axios.get(`/api/repositories/${this.reviewForm.repositoryId}/remote-branches`);
                        // ä¿®å¤ï¼šæ­£ç¡®å¤„ç†BranchListDTOçš„æ•°æ®ç»“æ„
                        this.branches = response.data.branches || [];
                        this.$message.success('è¿œç¨‹åˆ†æ”¯åŠ è½½æˆåŠŸ');
                    } catch (error) {
                        this.$message.error('åŠ è½½è¿œç¨‹åˆ†æ”¯å¤±è´¥: ' + (error.response?.data || error.message));
                    } finally {
                        this.remoteLoading = false;
                    }
                },
                
                async addRepository() {
                    try {
                        const response = await axios.post('/api/repositories', this.newRepository);
                        console.log('Repository created:', response.data);
                        this.showAddDialog = false;
                        this.newRepository = { name: '', url: '', username: '', password: '', description: '' };
                        await this.loadRepositories();
                        this.$message.success('ä»“åº“æ·»åŠ æˆåŠŸ');
                    } catch (error) {
                        console.error('Failed to add repository:', error);
                        this.$message.error('æ·»åŠ ä»“åº“å¤±è´¥: ' + (error.response?.data?.message || error.message));
                    }
                },
                
                async testConnection(repository) {
                    try {
                        await axios.post(`/api/repositories/${repository.id}/test-connection`);
                        this.$message.success('è¿æ¥æµ‹è¯•æˆåŠŸ');
                    } catch (error) {
                        this.$message.error('è¿æ¥æµ‹è¯•å¤±è´¥');
                    }
                },
                
                async deleteRepository(id) {
                    try {
                        await axios.delete(`/api/repositories/${id}`);
                        this.loadRepositories();
                        this.$message.success('åˆ é™¤æˆåŠŸ');
                    } catch (error) {
                        this.$message.error('åˆ é™¤å¤±è´¥');
                    }
                },
                
                async startReview() {
                    if (!this.reviewForm.repositoryId || !this.reviewForm.targetBranch) {
                        this.$message.warning('è¯·é€‰æ‹©ä»“åº“å’Œåˆ†æ”¯');
                        return;
                    }

                    this.reviewLoading = true;
                    this.reviewResult = '';
                    this.currentReviewId = null;

                    try {
                        // ä¿®å¤ï¼šä½¿ç”¨POSTè¯·æ±‚å¹¶é€šè¿‡FormDataä¼ é€’å‚æ•°
                        const params = new URLSearchParams();
                        params.append('baseBranch', this.reviewForm.baseBranch);
                        params.append('targetBranch', this.reviewForm.targetBranch);
                        params.append('mode', this.reviewForm.mode);

                        const response = await axios.post(
                            `/api/review/${this.reviewForm.repositoryId}/claude`,
                            params,
                            {
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded'
                                }
                            }
                        );
                        this.reviewResult = response.data;
                        // ä½¿ç”¨repositoryIdä½œä¸ºä¸´æ—¶çš„reviewIdï¼ˆç”¨äºæ–‡ä»¶å‘½åï¼‰
                        this.currentReviewId = this.reviewForm.repositoryId;
                        this.$message.success('Reviewå®Œæˆ');
                    } catch (error) {
                        this.$message.error('Reviewå¤±è´¥: ' + (error.response?.data || error.message));
                    } finally {
                        this.reviewLoading = false;
                    }
                },

                // è·å–å®¡æŸ¥æ¨¡å¼è¯´æ˜
                getModeDescription(mode) {
                    const descriptions = {
                        'quick': 'å¿«é€Ÿå®¡æŸ¥ï¼šä»…å…³æ³¨å…³é”®Bugã€å®‰å…¨æ¼æ´å’Œä¸¥é‡æ€§èƒ½é—®é¢˜ï¼Œé€‚åˆæ—¥å¸¸PRå®¡æŸ¥',
                        'standard': 'æ ‡å‡†å®¡æŸ¥ï¼šå¹³è¡¡çš„å®¡æŸ¥æ·±åº¦ï¼Œè¦†ç›–å¸¸è§çš„ä»£ç è´¨é‡é—®é¢˜ï¼Œé€‚åˆåŠŸèƒ½åˆå¹¶å‰æ£€æŸ¥',
                        'deep': 'æ·±åº¦å®¡æŸ¥ï¼šå…¨é¢æ·±å…¥çš„å®¡æŸ¥ï¼ŒåŒ…å«è¯¦ç»†çš„é—®é¢˜åˆ†çº§(P0-P3)ã€ä¿®å¤å»ºè®®å’Œä»£ç ç¤ºä¾‹ï¼Œé€‚åˆç‰ˆæœ¬å‘å¸ƒå‰çš„ä¸¥æ ¼å®¡æŸ¥',
                        'security': 'å®‰å…¨å®¡æŸ¥ï¼šä¸“æ³¨äºå®‰å…¨æ¼æ´æ£€æµ‹ï¼ŒåŒ…æ‹¬SQLæ³¨å…¥ã€XSSã€CSRFã€è®¤è¯æˆæƒç­‰é—®é¢˜',
                        'performance': 'æ€§èƒ½å®¡æŸ¥ï¼šä¸“æ³¨äºæ€§èƒ½é—®é¢˜ï¼ŒåŒ…æ‹¬N+1æŸ¥è¯¢ã€æ…¢SQLã€å†…å­˜æ³„æ¼ã€èµ„æºæœªå…³é—­ç­‰',
                        'architecture': 'æ¶æ„å®¡æŸ¥ï¼šå…³æ³¨æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬åˆ†å±‚è€¦åˆã€SOLIDåŸåˆ™ã€è®¾è®¡æ¨¡å¼åº”ç”¨ç­‰'
                    };
                    return descriptions[mode] || '';
                },

                // å¯¼å‡ºMarkdownæ ¼å¼æŠ¥å‘Š
                async exportMarkdown() {
                    if (!this.reviewResult) {
                        this.$message.warning('æ²¡æœ‰å¯å¯¼å‡ºçš„å®¡æŸ¥ç»“æœ');
                        return;
                    }

                    this.exportLoading = true;
                    try {
                        // åˆ›å»ºMarkdownå†…å®¹
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                        const filename = `review-${this.currentReviewId}-${timestamp}.md`;

                        // æ„å»ºå®Œæ•´çš„Markdownå†…å®¹
                        const repoName = this.repositories.find(r => r.id === this.reviewForm.repositoryId)?.name || 'Unknown';
                        const markdown = `# ä»£ç å®¡æŸ¥æŠ¥å‘Š

## åŸºæœ¬ä¿¡æ¯

- **ä»“åº“**: ${repoName}
- **åˆ†æ”¯**: ${this.reviewForm.baseBranch} â†’ ${this.reviewForm.targetBranch}
- **å®¡æŸ¥æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}

---

## å®¡æŸ¥ç»“æœ

${this.reviewResult}

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
**ç”Ÿæˆå·¥å…·**: Git Review Service
`;

                        // åˆ›å»ºBlobå¹¶ä¸‹è½½
                        const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);

                        this.$message.success('MarkdownæŠ¥å‘Šå·²å¯¼å‡º');
                    } catch (error) {
                        this.$message.error('å¯¼å‡ºå¤±è´¥: ' + error.message);
                    } finally {
                        this.exportLoading = false;
                    }
                },

                // å¯¼å‡ºJSONæ ¼å¼æŠ¥å‘Š
                async exportJson() {
                    if (!this.reviewResult) {
                        this.$message.warning('æ²¡æœ‰å¯å¯¼å‡ºçš„å®¡æŸ¥ç»“æœ');
                        return;
                    }

                    this.exportLoading = true;
                    try {
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                        const filename = `review-${this.currentReviewId}-${timestamp}.json`;

                        const repoName = this.repositories.find(r => r.id === this.reviewForm.repositoryId)?.name || 'Unknown';

                        // æ„å»ºJSONæ•°æ®
                        const jsonData = {
                            reviewId: this.currentReviewId,
                            repository: {
                                id: this.reviewForm.repositoryId,
                                name: repoName
                            },
                            branches: {
                                base: this.reviewForm.baseBranch,
                                target: this.reviewForm.targetBranch
                            },
                            reviewTime: new Date().toISOString(),
                            result: this.reviewResult,
                            metadata: {
                                generatedBy: 'Git Review Service',
                                version: '1.0.0'
                            }
                        };

                        // åˆ›å»ºBlobå¹¶ä¸‹è½½
                        const blob = new Blob([JSON.stringify(jsonData, null, 2)], {
                            type: 'application/json;charset=utf-8'
                        });
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);

                        this.$message.success('JSONæŠ¥å‘Šå·²å¯¼å‡º');
                    } catch (error) {
                        this.$message.error('å¯¼å‡ºå¤±è´¥: ' + error.message);
                    } finally {
                        this.exportLoading = false;
                    }
                },

                // æµ‹è¯•ç”Ÿæˆç›¸å…³æ–¹æ³•
                async loadTestBranches() {
                    if (!this.testGenForm.repositoryId) return;

                    try {
                        const response = await axios.get(`/api/git/${this.testGenForm.repositoryId}/branches`);
                        // ä¿®å¤ï¼šæ­£ç¡®å¤„ç†BranchListDTOçš„æ•°æ®ç»“æ„
                        this.testBranches = response.data.branches || [];
                    } catch (error) {
                        this.$message.error('åŠ è½½åˆ†æ”¯åˆ—è¡¨å¤±è´¥');
                    }
                },

                formatQualityTooltip(val) {
                    const levels = {
                        1: 'åŸºç¡€',
                        2: 'è‰¯å¥½',
                        3: 'æ ‡å‡†',
                        4: 'é«˜è´¨é‡',
                        5: 'å®Œç¾'
                    };
                    return levels[val] || 'æ ‡å‡†';
                },

                resetTestForm() {
                    this.testGenForm = {
                        repositoryId: '',
                        branch: 'master',
                        className: '',
                        gateId: '',
                        requirement: '',
                        testType: 'mock',
                        qualityLevel: 5
                    };
                    this.testGenProgress.show = false;
                    this.testGenResult.show = false;
                },

                async startTestGeneration() {
                    if (!this.testGenForm.repositoryId || !this.testGenForm.branch || !this.testGenForm.className) {
                        this.$message.warning('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                        return;
                    }

                    this.testGenLoading = true;
                    this.testGenProgress.show = true;
                    this.testGenProgress.currentStep = 0;
                    this.testGenProgress.percentage = 0;
                    this.testGenProgress.status = 'active';
                    this.testGenProgress.message = 'æ­£åœ¨åˆ†ææºç ...';
                    this.testGenResult.show = false;

                    try {
                        // è°ƒç”¨æµ‹è¯•ç”ŸæˆAPI
                        const response = await axios.post('/api/test-generation/generate', {
                            repositoryId: this.testGenForm.repositoryId,
                            branch: this.testGenForm.branch,
                            className: this.testGenForm.className,
                            gateId: this.testGenForm.gateId,
                            requirement: this.testGenForm.requirement,
                            testType: this.testGenForm.testType,
                            qualityLevel: this.testGenForm.qualityLevel
                        });

                        const taskId = response.data.taskId;

                        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
                        await this.pollTaskStatus(taskId);

                    } catch (error) {
                        this.testGenProgress.status = 'exception';
                        this.testGenProgress.message = 'ç”Ÿæˆå¤±è´¥: ' + (error.response?.data?.message || error.message);
                        this.$message.error('æµ‹è¯•ç”Ÿæˆå¤±è´¥');
                    } finally {
                        this.testGenLoading = false;
                    }
                },

                async pollTaskStatus(taskId) {
                    const pollInterval = 2000; // 2ç§’è½®è¯¢ä¸€æ¬¡
                    const maxPolls = 150; // æœ€å¤šè½®è¯¢5åˆ†é’Ÿ
                    let pollCount = 0;

                    const poll = async () => {
                        if (pollCount >= maxPolls) {
                            this.testGenProgress.status = 'exception';
                            this.testGenProgress.message = 'ç”Ÿæˆè¶…æ—¶';
                            return;
                        }

                        try {
                            const response = await axios.get(`/api/test-generation/status/${taskId}`);
                            const status = response.data;

                            // æ›´æ–°è¿›åº¦
                            this.updateProgress(status);

                            if (status.status === 'COMPLETED') {
                                // è·å–æœ€ç»ˆç»“æœ
                                await this.loadFinalResult(taskId);
                                return;
                            } else if (status.status === 'FAILED') {
                                this.testGenProgress.status = 'exception';
                                this.testGenProgress.message = 'ç”Ÿæˆå¤±è´¥: ' + status.message;
                                return;
                            }

                            // ç»§ç»­è½®è¯¢
                            pollCount++;
                            setTimeout(poll, pollInterval);

                        } catch (error) {
                            this.testGenProgress.status = 'exception';
                            this.testGenProgress.message = 'çŠ¶æ€æŸ¥è¯¢å¤±è´¥';
                        }
                    };

                    await poll();
                },

                updateProgress(status) {
                    const stepMap = {
                        'ANALYZING': { step: 0, message: 'æ­£åœ¨åˆ†æJavaç±»ç»“æ„...', percentage: 25 },
                        'GENERATING': { step: 1, message: 'æ­£åœ¨ç”Ÿæˆæµ‹è¯•ä»£ç ...', percentage: 50 },
                        'COMPILING': { step: 2, message: 'æ­£åœ¨éªŒè¯ç¼–è¯‘...', percentage: 75 },
                        'TESTING': { step: 3, message: 'æ­£åœ¨æ‰§è¡Œæµ‹è¯•...', percentage: 90 },
                        'COMPLETED': { step: 4, message: 'ç”Ÿæˆå®Œæˆ', percentage: 100 }
                    };

                    const progress = stepMap[status.status] || { step: 0, message: status.message, percentage: 0 };

                    this.testGenProgress.currentStep = progress.step;
                    this.testGenProgress.percentage = progress.percentage;
                    this.testGenProgress.message = progress.message;

                    if (status.status === 'COMPLETED') {
                        this.testGenProgress.status = 'success';
                    }
                },

                async loadFinalResult(taskId) {
                    try {
                        const response = await axios.get(`/api/test-generation/result/${taskId}`);
                        const result = response.data;

                        this.testGenResult = {
                            show: true,
                            taskId: taskId,
                            testCode: result.testCode,
                            testFileName: result.testFileName,
                            compilationSuccess: result.compilationSuccess,
                            testsPass: result.testsPass,
                            coveragePercentage: result.coveragePercentage || 0,
                            generationTime: result.generationTime || 0,
                            output: result.output || ''
                        };

                        this.$message.success('æµ‹è¯•ä»£ç ç”Ÿæˆå®Œæˆï¼');
                    } catch (error) {
                        this.$message.error('è·å–ç»“æœå¤±è´¥');
                    }
                },

                copyTestCode() {
                    if (!this.testGenResult.testCode) return;

                    // åˆ›å»ºä¸´æ—¶textareaå…ƒç´ å¤åˆ¶æ–‡æœ¬
                    const textarea = document.createElement('textarea');
                    textarea.value = this.testGenResult.testCode;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);

                    this.$message.success('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                },

                downloadTestCode() {
                    if (!this.testGenResult.testCode) return;

                    const blob = new Blob([this.testGenResult.testCode], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = this.testGenResult.testFileName || 'TestClass.java';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    this.$message.success('æ–‡ä»¶ä¸‹è½½å®Œæˆ');
                }
            }
        });
    </script>
</body>
</html>