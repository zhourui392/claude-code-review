<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git代码Review服务</title>
    <link href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
        }
        .review-result {
            background: #f5f7fa;
            padding: 20px;
            border-radius: 4px;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        .test-progress {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e6e6e6;
        }
        .test-result {
            margin-top: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e6e6e6;
        }
        .code-container {
            border: 1px solid #e6e6e6;
            border-radius: 4px;
            overflow: hidden;
        }
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f8f8;
            border-bottom: 1px solid #e6e6e6;
            font-weight: bold;
        }
        .code-content {
            background: #f5f5f5;
            padding: 15px;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
        }
        .test-output {
            margin-top: 15px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 4px;
            border: 1px solid #e6e6e6;
        }
        .test-output pre {
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.3;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>Git代码Review服务</h1>
                <p>使用Claude AI进行自动化代码审查</p>
            </div>

            <el-tabs type="border-card">
                <el-tab-pane label="仓库管理">
                    <div class="section">
                        <h3>Git仓库配置</h3>
                        <el-button type="primary" @click="showAddDialog = true">添加仓库</el-button>
                        
                        <el-table :data="repositories" style="width: 100%; margin-top: 20px;">
                            <el-table-column prop="name" label="仓库名称"></el-table-column>
                            <el-table-column prop="repositoryUrl" label="仓库地址"></el-table-column>
                            <el-table-column prop="description" label="描述"></el-table-column>
                            <el-table-column label="操作" width="200">
                                <template slot-scope="scope">
                                    <el-button size="mini" @click="testConnection(scope.row)">测试连接</el-button>
                                    <el-button size="mini" type="danger" @click="deleteRepository(scope.row.id)">删除</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>
                </el-tab-pane>

                <el-tab-pane label="代码Review">
                    <div class="section">
                        <h3>代码审查</h3>
                        
                        <el-form :model="reviewForm" label-width="120px">
                            <el-form-item label="选择仓库">
                                <el-select v-model="reviewForm.repositoryId" placeholder="请选择仓库" @change="loadBranches">
                                    <el-option v-for="repo in repositories" 
                                               :key="repo.id" 
                                               :label="repo.name" 
                                               :value="repo.id">
                                    </el-option>
                                </el-select>
                                <el-button style="margin-left: 10px" @click="loadRemoteBranches" :loading="remoteLoading">
                                    从远程拉取分支
                                </el-button>
                            </el-form-item>

                            <el-form-item label="基础分支">
                                <el-select v-model="reviewForm.baseBranch" placeholder="请选择基础分支" filterable allow-create>
                                    <el-option v-for="branch in branches" 
                                               :key="'base-' + branch" 
                                               :label="branch" 
                                               :value="branch">
                                    </el-option>
                                </el-select>
                            </el-form-item>
                            
                            <el-form-item label="目标分支">
                                <el-select v-model="reviewForm.targetBranch" placeholder="请选择目标分支" filterable allow-create>
                                    <el-option v-for="branch in branches" 
                                               :key="'target-' + branch" 
                                               :label="branch" 
                                               :value="branch">
                                    </el-option>
                                </el-select>
                            </el-form-item>

                            <el-form-item>
                                <el-button type="primary" @click="startReview" :loading="reviewLoading">
                                    开始Review
                                </el-button>
                            </el-form-item>
                        </el-form>

                        <div v-if="reviewResult" class="review-result">
                            <h4>Review结果：</h4>
                            <div>{{ reviewResult }}</div>
                        </div>
                    </div>
                </el-tab-pane>

                <el-tab-pane label="单元测试生成">
                    <div class="section">
                        <h3>智能单元测试生成</h3>

                        <el-form :model="testGenForm" label-width="120px">
                            <el-form-item label="选择仓库">
                                <el-select v-model="testGenForm.repositoryId" placeholder="请选择仓库" @change="loadTestBranches">
                                    <el-option v-for="repo in repositories"
                                               :key="repo.id"
                                               :label="repo.name"
                                               :value="repo.id">
                                    </el-option>
                                </el-select>
                            </el-form-item>

                            <el-form-item label="分支">
                                <el-select v-model="testGenForm.branch" placeholder="请选择分支" filterable allow-create>
                                    <el-option v-for="branch in testBranches"
                                               :key="'test-' + branch"
                                               :label="branch"
                                               :value="branch">
                                    </el-option>
                                </el-select>
                            </el-form-item>

                            <el-form-item label="Java类名">
                                <el-input
                                    type="textarea"
                                    v-model="testGenForm.className"
                                    :rows="3"
                                    placeholder="例如: UserService 或 UserService,OrderService,ProductService (逗号分隔多个类)">
                                </el-input>
                                <div style="color: #909399; font-size: 12px; margin-top: 5px;">
                                    支持输入多个类名，使用英文逗号分隔
                                </div>
                            </el-form-item>

                            <el-form-item label="准入ID">
                                <el-input v-model="testGenForm.gateId" placeholder="可选，未填写则从Git历史提取">
                                    <template slot="prepend">Gate ID</template>
                                </el-input>
                                <div style="color: #909399; font-size: 12px; margin-top: 5px;">
                                    如不填写，系统将自动从最近的Git提交历史中提取准入ID
                                </div>
                            </el-form-item>

                            <el-form-item label="测试类型">
                                <el-select v-model="testGenForm.testType" placeholder="请选择测试类型">
                                    <el-option label="基础单元测试" value="basic"></el-option>
                                    <el-option label="全面测试覆盖" value="comprehensive"></el-option>
                                    <el-option label="Mock测试" value="mock"></el-option>
                                    <el-option label="集成测试" value="integration"></el-option>
                                </el-select>
                            </el-form-item>

                            <el-form-item label="质量要求">
                                <el-slider v-model="testGenForm.qualityLevel"
                                          :min="1" :max="5"
                                          show-stops
                                          :format-tooltip="formatQualityTooltip">
                                </el-slider>
                            </el-form-item>

                            <el-form-item>
                                <el-button type="primary" @click="startTestGeneration" :loading="testGenLoading">
                                    生成测试代码
                                </el-button>
                                <el-button @click="resetTestForm">重置</el-button>
                            </el-form-item>
                        </el-form>

                        <!-- 进度显示 -->
                        <div v-if="testGenProgress.show" class="test-progress">
                            <h4>生成进度</h4>
                            <el-steps :active="testGenProgress.currentStep" finish-status="success">
                                <el-step title="分析源码" description="解析Java类结构"></el-step>
                                <el-step title="生成测试" description="Claude AI生成测试代码"></el-step>
                                <el-step title="验证编译" description="检查测试代码语法"></el-step>
                                <el-step title="执行测试" description="运行并验证测试"></el-step>
                            </el-steps>
                            <el-progress :percentage="testGenProgress.percentage"
                                        :status="testGenProgress.status"
                                        style="margin-top: 20px;">
                            </el-progress>
                            <div v-if="testGenProgress.message" style="margin-top: 10px; color: #666;">
                                {{ testGenProgress.message }}
                            </div>
                        </div>

                        <!-- 结果展示 -->
                        <div v-if="testGenResult.show" class="test-result">
                            <h4>生成结果</h4>
                            <el-tabs type="card">
                                <el-tab-pane label="测试代码">
                                    <div class="code-container">
                                        <div class="code-header">
                                            <span>{{ testGenResult.testFileName }}</span>
                                            <div>
                                                <el-button size="mini" @click="copyTestCode">复制代码</el-button>
                                                <el-button size="mini" type="primary" @click="downloadTestCode">下载文件</el-button>
                                            </div>
                                        </div>
                                        <pre class="code-content"><code>{{ testGenResult.testCode }}</code></pre>
                                    </div>
                                </el-tab-pane>
                                <el-tab-pane label="执行结果">
                                    <el-descriptions border>
                                        <el-descriptions-item label="编译状态">
                                            <el-tag :type="testGenResult.compilationSuccess ? 'success' : 'danger'">
                                                {{ testGenResult.compilationSuccess ? '编译成功' : '编译失败' }}
                                            </el-tag>
                                        </el-descriptions-item>
                                        <el-descriptions-item label="测试通过">
                                            <el-tag :type="testGenResult.testsPass ? 'success' : 'warning'">
                                                {{ testGenResult.testsPass ? '全部通过' : '部分失败' }}
                                            </el-tag>
                                        </el-descriptions-item>
                                        <el-descriptions-item label="覆盖率">
                                            <span>{{ testGenResult.coveragePercentage }}%</span>
                                        </el-descriptions-item>
                                        <el-descriptions-item label="生成时间">
                                            <span>{{ testGenResult.generationTime }}秒</span>
                                        </el-descriptions-item>
                                    </el-descriptions>
                                    <div v-if="testGenResult.output" class="test-output">
                                        <h5>执行输出：</h5>
                                        <pre>{{ testGenResult.output }}</pre>
                                    </div>
                                </el-tab-pane>
                            </el-tabs>
                        </div>
                    </div>
                </el-tab-pane>
            </el-tabs>

            <!-- 添加仓库对话框 -->
            <el-dialog title="添加Git仓库" :visible.sync="showAddDialog" width="500px">
                <el-form :model="newRepository" label-width="100px">
                    <el-form-item label="仓库名称">
                        <el-input v-model="newRepository.name"></el-input>
                    </el-form-item>
                    <el-form-item label="仓库地址">
                        <el-input v-model="newRepository.url"></el-input>
                    </el-form-item>
                    <el-form-item label="用户名">
                        <el-input v-model="newRepository.username"></el-input>
                    </el-form-item>
                    <el-form-item label="密码">
                        <el-input v-model="newRepository.password" type="password"></el-input>
                    </el-form-item>
                    <el-form-item label="描述">
                        <el-input v-model="newRepository.description" type="textarea"></el-input>
                    </el-form-item>
                </el-form>
                <span slot="footer" class="dialog-footer">
                    <el-button @click="showAddDialog = false">取消</el-button>
                    <el-button type="primary" @click="addRepository">确定</el-button>
                </span>
            </el-dialog>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    repositories: [],
                    branches: [],
                    testBranches: [],
                    reviewForm: {
                        repositoryId: '',
                        baseBranch: 'master',
                        targetBranch: ''
                    },
                    testGenForm: {
                        repositoryId: '',
                        branch: 'master',
                        className: '',
                        gateId: '',
                        testType: 'basic',
                        qualityLevel: 3
                    },
                    newRepository: {
                        name: '',
                        url: '',
                        username: '',
                        password: '',
                        description: ''
                    },
                    showAddDialog: false,
                    reviewLoading: false,
                    remoteLoading: false,
                    testGenLoading: false,
                    reviewResult: '',
                    testGenProgress: {
                        show: false,
                        currentStep: 0,
                        percentage: 0,
                        status: '',
                        message: ''
                    },
                    testGenResult: {
                        show: false,
                        taskId: '',
                        testCode: '',
                        testFileName: '',
                        compilationSuccess: false,
                        testsPass: false,
                        coveragePercentage: 0,
                        generationTime: 0,
                        output: ''
                    }
                }
            },
            mounted() {
                this.loadRepositories();
            },
            methods: {
                async loadRepositories() {
                    try {
                        const response = await axios.get('/api/repositories');
                        console.log('Loaded repositories:', response.data);
                        this.repositories = response.data;
                    } catch (error) {
                        console.error('Failed to load repositories:', error);
                        this.$message.error('加载仓库列表失败');
                    }
                },
                
                async loadBranches() {
                    if (!this.reviewForm.repositoryId) return;
                    
                    try {
                        const response = await axios.get(`/api/git/${this.reviewForm.repositoryId}/branches`);
                        // 修复：正确处理BranchListDTO的数据结构
                        this.branches = response.data.branches || [];
                    } catch (error) {
                        this.$message.error('加载分支列表失败');
                    }
                },
                
                async loadRemoteBranches() {
                    if (!this.reviewForm.repositoryId) {
                        this.$message.warning('请先选择仓库');
                        return;
                    }
                    
                    this.remoteLoading = true;
                    try {
                        const response = await axios.get(`/api/repositories/${this.reviewForm.repositoryId}/remote-branches`);
                        // 修复：正确处理BranchListDTO的数据结构
                        this.branches = response.data.branches || [];
                        this.$message.success('远程分支加载成功');
                    } catch (error) {
                        this.$message.error('加载远程分支失败: ' + (error.response?.data || error.message));
                    } finally {
                        this.remoteLoading = false;
                    }
                },
                
                async addRepository() {
                    try {
                        const response = await axios.post('/api/repositories', this.newRepository);
                        console.log('Repository created:', response.data);
                        this.showAddDialog = false;
                        this.newRepository = { name: '', url: '', username: '', password: '', description: '' };
                        await this.loadRepositories();
                        this.$message.success('仓库添加成功');
                    } catch (error) {
                        console.error('Failed to add repository:', error);
                        this.$message.error('添加仓库失败: ' + (error.response?.data?.message || error.message));
                    }
                },
                
                async testConnection(repository) {
                    try {
                        await axios.post(`/api/repositories/${repository.id}/test-connection`);
                        this.$message.success('连接测试成功');
                    } catch (error) {
                        this.$message.error('连接测试失败');
                    }
                },
                
                async deleteRepository(id) {
                    try {
                        await axios.delete(`/api/repositories/${id}`);
                        this.loadRepositories();
                        this.$message.success('删除成功');
                    } catch (error) {
                        this.$message.error('删除失败');
                    }
                },
                
                async startReview() {
                    if (!this.reviewForm.repositoryId || !this.reviewForm.targetBranch) {
                        this.$message.warning('请选择仓库和分支');
                        return;
                    }

                    this.reviewLoading = true;
                    this.reviewResult = '';

                    try {
                        // 修复：使用POST请求并通过FormData传递参数
                        const params = new URLSearchParams();
                        params.append('baseBranch', this.reviewForm.baseBranch);
                        params.append('targetBranch', this.reviewForm.targetBranch);

                        const response = await axios.post(
                            `/api/review/${this.reviewForm.repositoryId}/claude`,
                            params,
                            {
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded'
                                }
                            }
                        );
                        this.reviewResult = response.data;
                        this.$message.success('Review完成');
                    } catch (error) {
                        this.$message.error('Review失败: ' + (error.response?.data || error.message));
                    } finally {
                        this.reviewLoading = false;
                    }
                },

                // 测试生成相关方法
                async loadTestBranches() {
                    if (!this.testGenForm.repositoryId) return;

                    try {
                        const response = await axios.get(`/api/git/${this.testGenForm.repositoryId}/branches`);
                        // 修复：正确处理BranchListDTO的数据结构
                        this.testBranches = response.data.branches || [];
                    } catch (error) {
                        this.$message.error('加载分支列表失败');
                    }
                },

                formatQualityTooltip(val) {
                    const levels = {
                        1: '基础',
                        2: '良好',
                        3: '标准',
                        4: '高质量',
                        5: '完美'
                    };
                    return levels[val] || '标准';
                },

                resetTestForm() {
                    this.testGenForm = {
                        repositoryId: '',
                        branch: 'master',
                        className: '',
                        gateId: '',
                        testType: 'basic',
                        qualityLevel: 3
                    };
                    this.testGenProgress.show = false;
                    this.testGenResult.show = false;
                },

                async startTestGeneration() {
                    if (!this.testGenForm.repositoryId || !this.testGenForm.branch || !this.testGenForm.className) {
                        this.$message.warning('请填写所有必填字段');
                        return;
                    }

                    this.testGenLoading = true;
                    this.testGenProgress.show = true;
                    this.testGenProgress.currentStep = 0;
                    this.testGenProgress.percentage = 0;
                    this.testGenProgress.status = 'active';
                    this.testGenProgress.message = '正在分析源码...';
                    this.testGenResult.show = false;

                    try {
                        // 调用测试生成API
                        const response = await axios.post('/api/test-generation/generate', {
                            repositoryId: this.testGenForm.repositoryId,
                            branch: this.testGenForm.branch,
                            className: this.testGenForm.className,
                            testType: this.testGenForm.testType,
                            qualityLevel: this.testGenForm.qualityLevel
                        });

                        const taskId = response.data.taskId;

                        // 轮询任务状态
                        await this.pollTaskStatus(taskId);

                    } catch (error) {
                        this.testGenProgress.status = 'exception';
                        this.testGenProgress.message = '生成失败: ' + (error.response?.data?.message || error.message);
                        this.$message.error('测试生成失败');
                    } finally {
                        this.testGenLoading = false;
                    }
                },

                async pollTaskStatus(taskId) {
                    const pollInterval = 2000; // 2秒轮询一次
                    const maxPolls = 150; // 最多轮询5分钟
                    let pollCount = 0;

                    const poll = async () => {
                        if (pollCount >= maxPolls) {
                            this.testGenProgress.status = 'exception';
                            this.testGenProgress.message = '生成超时';
                            return;
                        }

                        try {
                            const response = await axios.get(`/api/test-generation/status/${taskId}`);
                            const status = response.data;

                            // 更新进度
                            this.updateProgress(status);

                            if (status.status === 'COMPLETED') {
                                // 获取最终结果
                                await this.loadFinalResult(taskId);
                                return;
                            } else if (status.status === 'FAILED') {
                                this.testGenProgress.status = 'exception';
                                this.testGenProgress.message = '生成失败: ' + status.message;
                                return;
                            }

                            // 继续轮询
                            pollCount++;
                            setTimeout(poll, pollInterval);

                        } catch (error) {
                            this.testGenProgress.status = 'exception';
                            this.testGenProgress.message = '状态查询失败';
                        }
                    };

                    await poll();
                },

                updateProgress(status) {
                    const stepMap = {
                        'ANALYZING': { step: 0, message: '正在分析Java类结构...', percentage: 25 },
                        'GENERATING': { step: 1, message: '正在生成测试代码...', percentage: 50 },
                        'COMPILING': { step: 2, message: '正在验证编译...', percentage: 75 },
                        'TESTING': { step: 3, message: '正在执行测试...', percentage: 90 },
                        'COMPLETED': { step: 4, message: '生成完成', percentage: 100 }
                    };

                    const progress = stepMap[status.status] || { step: 0, message: status.message, percentage: 0 };

                    this.testGenProgress.currentStep = progress.step;
                    this.testGenProgress.percentage = progress.percentage;
                    this.testGenProgress.message = progress.message;

                    if (status.status === 'COMPLETED') {
                        this.testGenProgress.status = 'success';
                    }
                },

                async loadFinalResult(taskId) {
                    try {
                        const response = await axios.get(`/api/test-generation/result/${taskId}`);
                        const result = response.data;

                        this.testGenResult = {
                            show: true,
                            taskId: taskId,
                            testCode: result.testCode,
                            testFileName: result.testFileName,
                            compilationSuccess: result.compilationSuccess,
                            testsPass: result.testsPass,
                            coveragePercentage: result.coveragePercentage || 0,
                            generationTime: result.generationTime || 0,
                            output: result.output || ''
                        };

                        this.$message.success('测试代码生成完成！');
                    } catch (error) {
                        this.$message.error('获取结果失败');
                    }
                },

                copyTestCode() {
                    if (!this.testGenResult.testCode) return;

                    // 创建临时textarea元素复制文本
                    const textarea = document.createElement('textarea');
                    textarea.value = this.testGenResult.testCode;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);

                    this.$message.success('代码已复制到剪贴板');
                },

                downloadTestCode() {
                    if (!this.testGenResult.testCode) return;

                    const blob = new Blob([this.testGenResult.testCode], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = this.testGenResult.testFileName || 'TestClass.java';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    this.$message.success('文件下载完成');
                }
            }
        });
    </script>
</body>
</html>